'use strict';

// sepc.js
var chai = require('chai');
chai.use(require('sinon-chai'));
var Promise = require('bluebird');
var expect = chai.expect;
var sinon = require('sinon');
var _ = require('lodash');
var stream = require('stream');
var proxyquire = require('proxyquire');
var EventEmitter = require('events').EventEmitter;
var errors = require('request-promise/errors');

var actor = require('./actor');

describe('actor', function () {
  var s1, s2, ee;

  beforeEach(function () {
    s1 = new stream.Readable({ objectMode: true, read: sinon.stub() });
    s2 = new stream.Transform({ objectMode: true, highWaterMark: 2 });
    s2._transform = function (d, e, cb) {
      return cb(null, d);
    };
  });

  describe('_write', function () {

    it('calls the callback immediately if the write queue is open', function (done) {
      actor._write(s2, 'foo').then(function () {
        return done();
      });
    });

    it('calls the callback after drain, if the write queue is full', function (done) {

      s2.write = sinon.stub();
      s2.write.returns(false);
      var resolved = false;

      actor._write(s2, 'foo').then(function () {
        resolved = true;
        done();
      });

      setTimeout(function () {
        expect(resolved).to.be.false;
        s2.write.returns(true);
        s2.emit('drain');
      });
    });
  });

  describe('_consume', function () {
    var transform, ee;

    beforeEach(function () {
      actor._write = sinon.stub().returns(Promise.resolve(null));
      transform = sinon.stub();
      ee = new EventEmitter();
    });

    it('calls transform with input from stream', function (done) {
      transform.returns(Promise.resolve({}));

      s1.push('url1');
      actor._consume(s1, s2, transform, ee).then(function () {
        expect(transform).to.be.calledWith('url1');
        done();
      });
    });

    it('recurses on itself with passed params while the going is good', function (done) {
      transform.returns(Promise.resolve({ params: 'foo' }));

      s1.push('url1');
      s1.push('url2');
      s1.push(null);

      actor._consume(s1, s2, transform, ee).then(function () {
        expect(transform).to.have.been.calledTwice;
        expect(transform.secondCall.args[1]).to.equal('foo');
        expect(transform.secondCall.args[0]).to.equal('url2');
        done();
      });
    });

    it('rejects when transform throws', function (done) {
      var error = new Error('foo');
      transform.returns(Promise.reject(error));
      s1.push('url1');
      s1.push('url2');
      s1.push(null);

      actor._write = sinon.stub();

      actor._consume(s1, s2, transform, ee).catch(function (err) {
        expect(actor._write).to.not.have.been.called;
        expect(err).to.equal(error);
        done();
      });
    });
  });

  describe('start', function () {
    beforeEach(function () {
      actor._consume = sinon.stub();
    });

    it('emits on end event only after the consumer resolves as finished', function (done) {
      var resolve;
      var promise = new Promise(function (_resolve, __) {
        resolve = _resolve;
      });

      actor._consume.returns(promise);

      var ended = false;
      var e = actor.start(s1, s2);
      e.on('end', function () {
        ended = true;
        process.nextTick(function () {
          expect(e.listenerCount('end')).to.equal(0);
          expect(e.listenerCount('error')).to.equal(0);
          done();
        });
      });

      setTimeout(function () {
        expect(ended).to.be.false;
        resolve();
      });
    });

    it('emits an error event if the consumer rejects', function (done) {
      var error = new Error('foo');
      actor._consume.returns(Promise.reject(error));

      var a = actor.start(s1, s2);
      a.on('error', function (err) {
        expect(err).to.equal(error);
        process.nextTick(function () {
          expect(a.listenerCount('error')).to.equal(0);
          done();
        });
      });
    });

    it('emits an error event if consumer throws for any reason', function (done) {
      actor._consume.throws();
      var a = actor.start(s1, s2);
      a.on('error', function (err) {
        expect(err).to.be.an('error');
        process.nextTick(function () {
          expect(a.listenerCount('error')).to.equal(0);
          done();
        });
      });
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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QWUsRUFBZixDQUFrQixFQUFsQixDQUFxQixPQUFyQixFQURtQjtBQUVuQixnQkFBUSxRQUFSLENBQWlCLFlBQU07QUFDckIsaUJBQU8sRUFBRSxhQUFGLENBQWdCLE9BQWhCLENBQVAsRUFBaUMsRUFBakMsQ0FBb0MsS0FBcEMsQ0FBMEMsQ0FBMUMsRUFEcUI7QUFFckIsaUJBRnFCO1NBQU4sQ0FBakIsQ0FGbUI7T0FBUCxDQUFkLENBSG1FO0tBQVIsQ0FBN0QsQ0E1Q3NCO0dBQU4sQ0FBbEIsQ0E3RnNCO0NBQU4sQ0FBbEIiLCJmaWxlIjoiYWN0b3Iuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHNlcGMuanNcbnZhciBjaGFpID0gcmVxdWlyZSgnY2hhaScpO1xuY2hhaS51c2UocmVxdWlyZSgnc2lub24tY2hhaScpKTtcbnZhciBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbnZhciBleHBlY3QgPSBjaGFpLmV4cGVjdDtcbnZhciBzaW5vbiA9IHJlcXVpcmUoJ3Npbm9uJyk7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1xudmFyIHByb3h5cXVpcmUgPSByZXF1aXJlKCdwcm94eXF1aXJlJyk7XG52YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyO1xudmFyIGVycm9ycyA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZS9lcnJvcnMnKTtcblxudmFyIGFjdG9yID0gcmVxdWlyZSgnLi9hY3RvcicpXG5cbmRlc2NyaWJlKCdhY3RvcicsICgpID0+IHtcbiAgdmFyIHMxLCBzMiwgZWU7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgczEgPSBuZXcgc3RyZWFtLlJlYWRhYmxlKHsgb2JqZWN0TW9kZTogdHJ1ZSwgcmVhZDogc2lub24uc3R1YigpIH0pO1xuICAgIHMyID0gbmV3IHN0cmVhbS5UcmFuc2Zvcm0oeyBvYmplY3RNb2RlOiB0cnVlLCBoaWdoV2F0ZXJNYXJrOiAyfSk7XG4gICAgczIuX3RyYW5zZm9ybSA9IChkLCBlLCBjYikgPT4gY2IobnVsbCwgZCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdfd3JpdGUnLCAoKSA9PiB7XG5cbiAgICBpdCgnY2FsbHMgdGhlIGNhbGxiYWNrIGltbWVkaWF0ZWx5IGlmIHRoZSB3cml0ZSBxdWV1ZSBpcyBvcGVuJywgZG9uZSA9PiB7XG4gICAgICBhY3Rvci5fd3JpdGUoczIsICdmb28nKS50aGVuKCgpID0+IGRvbmUoKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnY2FsbHMgdGhlIGNhbGxiYWNrIGFmdGVyIGRyYWluLCBpZiB0aGUgd3JpdGUgcXVldWUgaXMgZnVsbCcsIGRvbmUgPT4ge1xuXG4gICAgICBzMi53cml0ZSA9IHNpbm9uLnN0dWIoKTtcbiAgICAgIHMyLndyaXRlLnJldHVybnMoZmFsc2UpO1xuICAgICAgdmFyIHJlc29sdmVkID0gZmFsc2U7XG5cbiAgICAgIGFjdG9yXG4gICAgICAgIC5fd3JpdGUoczIsICdmb28nKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBleHBlY3QocmVzb2x2ZWQpLnRvLmJlLmZhbHNlO1xuICAgICAgICBzMi53cml0ZS5yZXR1cm5zKHRydWUpO1xuICAgICAgICBzMi5lbWl0KCdkcmFpbicpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdfY29uc3VtZScsICgpID0+IHtcbiAgICB2YXIgdHJhbnNmb3JtLCBlZTtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgYWN0b3IuX3dyaXRlID0gc2lub24uc3R1YigpLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKG51bGwpKTtcbiAgICAgIHRyYW5zZm9ybSA9IHNpbm9uLnN0dWIoKTtcbiAgICAgIGVlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2NhbGxzIHRyYW5zZm9ybSB3aXRoIGlucHV0IGZyb20gc3RyZWFtJywgZG9uZSA9PiB7XG4gICAgICB0cmFuc2Zvcm0ucmV0dXJucyhQcm9taXNlLnJlc29sdmUoe30pKVxuXG4gICAgICBzMS5wdXNoKCd1cmwxJyk7XG4gICAgICBhY3RvclxuICAgICAgICAuX2NvbnN1bWUoczEsIHMyLCB0cmFuc2Zvcm0sIGVlKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHRyYW5zZm9ybSkudG8uYmUuY2FsbGVkV2l0aCgndXJsMScpXG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdyZWN1cnNlcyBvbiBpdHNlbGYgd2l0aCBwYXNzZWQgcGFyYW1zIHdoaWxlIHRoZSBnb2luZyBpcyBnb29kJywgZG9uZSA9PiB7XG4gICAgICB0cmFuc2Zvcm0ucmV0dXJucyhQcm9taXNlLnJlc29sdmUoe3BhcmFtczogJ2ZvbycgfSkpXG5cbiAgICAgIHMxLnB1c2goJ3VybDEnKTtcbiAgICAgIHMxLnB1c2goJ3VybDInKTtcbiAgICAgIHMxLnB1c2gobnVsbCk7XG5cbiAgICAgIGFjdG9yXG4gICAgICAgIC5fY29uc3VtZShzMSwgczIsIHRyYW5zZm9ybSwgZWUpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICBleHBlY3QodHJhbnNmb3JtKS50by5oYXZlLmJlZW4uY2FsbGVkVHdpY2U7XG4gICAgICAgICAgZXhwZWN0KHRyYW5zZm9ybS5zZWNvbmRDYWxsLmFyZ3NbMV0pLnRvLmVxdWFsKCdmb28nKVxuICAgICAgICAgIGV4cGVjdCh0cmFuc2Zvcm0uc2Vjb25kQ2FsbC5hcmdzWzBdKS50by5lcXVhbCgndXJsMicpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgncmVqZWN0cyB3aGVuIHRyYW5zZm9ybSB0aHJvd3MnLCBkb25lID0+IHtcbiAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignZm9vJyk7XG4gICAgICB0cmFuc2Zvcm0ucmV0dXJucyhQcm9taXNlLnJlamVjdChlcnJvcikpXG4gICAgICBzMS5wdXNoKCd1cmwxJyk7XG4gICAgICBzMS5wdXNoKCd1cmwyJyk7XG4gICAgICBzMS5wdXNoKG51bGwpO1xuXG4gICAgICBhY3Rvci5fd3JpdGUgPSBzaW5vbi5zdHViKCk7XG5cbiAgICAgIGFjdG9yXG4gICAgICAgIC5fY29uc3VtZShzMSwgczIsIHRyYW5zZm9ybSwgZWUpXG4gICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIGV4cGVjdChhY3Rvci5fd3JpdGUpLnRvLm5vdC5oYXZlLmJlZW4uY2FsbGVkO1xuICAgICAgICAgIGV4cGVjdChlcnIpLnRvLmVxdWFsKGVycm9yKTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc3RhcnQnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBhY3Rvci5fY29uc3VtZSA9IHNpbm9uLnN0dWIoKTtcbiAgICB9KTtcblxuICAgIGl0KCdlbWl0cyBvbiBlbmQgZXZlbnQgb25seSBhZnRlciB0aGUgY29uc3VtZXIgcmVzb2x2ZXMgYXMgZmluaXNoZWQnLCBkb25lICA9PiB7XG4gICAgICB2YXIgcmVzb2x2ZTtcbiAgICAgIHZhciBwcm9taXNlID0gbmV3IFByb21pc2UoKF9yZXNvbHZlLCBfXykgPT4ge1xuICAgICAgICByZXNvbHZlID0gX3Jlc29sdmVcbiAgICAgIH0pO1xuXG4gICAgICBhY3Rvci5fY29uc3VtZS5yZXR1cm5zKHByb21pc2UpO1xuXG4gICAgICB2YXIgZW5kZWQgPSBmYWxzZTtcbiAgICAgIHZhciBlID0gYWN0b3Iuc3RhcnQoczEsIHMyKTtcbiAgICAgIGUub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgZW5kZWQgPSB0cnVlO1xuICAgICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICBleHBlY3QoZS5saXN0ZW5lckNvdW50KCdlbmQnKSkudG8uZXF1YWwoMCk7XG4gICAgICAgICAgZXhwZWN0KGUubGlzdGVuZXJDb3VudCgnZXJyb3InKSkudG8uZXF1YWwoMCk7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgZXhwZWN0KGVuZGVkKS50by5iZS5mYWxzZTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZW1pdHMgYW4gZXJyb3IgZXZlbnQgaWYgdGhlIGNvbnN1bWVyIHJlamVjdHMnLCBkb25lID0+IHtcbiAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignZm9vJyk7XG4gICAgICBhY3Rvci5fY29uc3VtZS5yZXR1cm5zKFByb21pc2UucmVqZWN0KGVycm9yKSk7XG5cbiAgICAgIHZhciBhID0gYWN0b3Iuc3RhcnQoczEsIHMyKTtcbiAgICAgIGEub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgZXhwZWN0KGVycikudG8uZXF1YWwoZXJyb3IpO1xuICAgICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICBleHBlY3QoYS5saXN0ZW5lckNvdW50KCdlcnJvcicpKS50by5lcXVhbCgwKVxuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdlbWl0cyBhbiBlcnJvciBldmVudCBpZiBjb25zdW1lciB0aHJvd3MgZm9yIGFueSByZWFzb24nLCBkb25lID0+IHtcbiAgICAgIGFjdG9yLl9jb25zdW1lLnRocm93cygpO1xuICAgICAgdmFyIGEgPSBhY3Rvci5zdGFydChzMSwgczIpO1xuICAgICAgYS5vbignZXJyb3InLCBlcnIgPT4ge1xuICAgICAgICBleHBlY3QoZXJyKS50by5iZS5hbignZXJyb3InKTtcbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KGEubGlzdGVuZXJDb3VudCgnZXJyb3InKSkudG8uZXF1YWwoMCk7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19