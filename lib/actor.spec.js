'use strict';

// sepc.js
var chai = require('chai');
chai.use(require('sinon-chai'));
var Promise = require('bluebird');
var expect = chai.expect;
var sinon = require('sinon');
var _ = require('lodash');
var stream = require('stream');
var proxyquire = require('proxyquire');
var EventEmitter = require('events').EventEmitter;
var errors = require('request-promise/errors');

var actor = require('./actor');

describe('actor', function () {
  var s1, s2, ee;

  beforeEach(function () {
    s1 = new stream.Readable({ objectMode: true, read: sinon.stub() });
    s2 = new stream.Transform({ objectMode: true, highWaterMark: 2 });
    s2._transform = function (d, e, cb) {
      return cb(null, d);
    };
  });

  describe('_write', function () {

    it('calls the callback immediately if the write queue is open', function (done) {
      actor._write(s2, 'foo').then(done);
    });

    it('calls the callback after drain, if the write queue is full', function (done) {

      s2.write = sinon.stub();
      s2.write.returns(false);
      var resolved = false;

      actor._write(s2, 'foo').then(function () {
        resolved = true;
        done();
      });

      setTimeout(function () {
        expect(resolved).to.be.false;
        s2.write.returns(true);
        s2.emit('drain');
      });
    });
  });

  describe('_consume', function () {
    var transform, ee;

    beforeEach(function () {
      actor._write = sinon.stub().returns(Promise.resolve(null));
      transform = sinon.stub();
      ee = new EventEmitter();
    });

    it('calls transform with input from stream', function (done) {
      transform.returns(Promise.resolve({}));

      s1.push('url1');
      actor._consume(s1, s2, transform, ee).then(function () {
        expect(transform).to.be.calledWith('url1');
        done();
      });
    });

    it('recurses on itself with passed params while the going is good', function (done) {
      transform.returns(Promise.resolve({ params: 'foo' }));

      s1.push('url1');
      s1.push('url2');
      s1.push(null);

      actor._consume(s1, s2, transform, ee).then(function () {
        expect(transform).to.have.been.calledTwice;
        expect(transform.secondCall.args[1]).to.equal('foo');
        expect(transform.secondCall.args[0]).to.equal('url2');
        done();
      });
    });

    it('rejects when transform throws', function (done) {
      var error = new Error('foo');
      transform.returns(Promise.reject(error));
      s1.push('url1');
      s1.push('url2');
      s1.push(null);

      actor._write = sinon.stub();

      actor._consume(s1, s2, transform, ee).catch(function (err) {
        expect(actor._write).to.not.have.been.called;
        expect(err).to.equal(error);
        done();
      });
    });
  });

  describe('start', function () {
    beforeEach(function () {
      actor._consume = sinon.stub();
    });

    it('emits on end event only after the consumer resolves as finished', function (done) {
      var resolve;
      var promise = new Promise(function (_resolve, __) {
        resolve = _resolve;
      });

      actor._consume.returns(promise);

      var ended = false;
      var e = actor.start(s1, s2);
      e.on('end', function () {
        ended = true;
        process.nextTick(function () {
          expect(e.listenerCount('end')).to.equal(0);
          expect(e.listenerCount('error')).to.equal(0);
          done();
        });
      });

      setTimeout(function () {
        expect(ended).to.be.false;
        resolve();
      });
    });

    it('emits an error event if the consumer rejects', function (done) {
      var error = new Error('foo');
      actor._consume.returns(Promise.reject(error));

      var a = actor.start(s1, s2);
      a.on('error', function (err) {
        expect(err).to.equal(error);
        process.nextTick(function () {
          expect(a.listenerCount('error')).to.equal(0);
          done();
        });
      });
    });

    it('emits an error event if consumer throws for any reason', function (done) {
      actor._consume.throws();
      var a = actor.start(s1, s2);
      a.on('error', function (err) {
        expect(err).to.be.an('error');
        process.nextTick(function () {
          expect(a.listenerCount('error')).to.equal(0);
          done();
        });
      });
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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QWtCLEVBQWxCLENBQXFCLE9BQXJCLEVBRG1CO0FBRW5CLGdCQUFRLFFBQVIsQ0FBaUIsWUFBTTtBQUNyQixpQkFBTyxFQUFFLGFBQUYsQ0FBZ0IsT0FBaEIsQ0FBUCxFQUFpQyxFQUFqQyxDQUFvQyxLQUFwQyxDQUEwQyxDQUExQyxFQURxQjtBQUVyQixpQkFGcUI7U0FBTixDQUFqQixDQUZtQjtPQUFQLENBQWQsQ0FIbUU7S0FBUixDQUE3RCxDQTVDc0I7R0FBTixDQUFsQixDQTdGc0I7Q0FBTixDQUFsQiIsImZpbGUiOiJhY3Rvci5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gc2VwYy5qc1xudmFyIGNoYWkgPSByZXF1aXJlKCdjaGFpJyk7XG5jaGFpLnVzZShyZXF1aXJlKCdzaW5vbi1jaGFpJykpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xudmFyIGV4cGVjdCA9IGNoYWkuZXhwZWN0O1xudmFyIHNpbm9uID0gcmVxdWlyZSgnc2lub24nKTtcbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgc3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7XG52YXIgcHJveHlxdWlyZSA9IHJlcXVpcmUoJ3Byb3h5cXVpcmUnKTtcbnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG52YXIgZXJyb3JzID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlL2Vycm9ycycpO1xuXG52YXIgYWN0b3IgPSByZXF1aXJlKCcuL2FjdG9yJylcblxuZGVzY3JpYmUoJ2FjdG9yJywgKCkgPT4ge1xuICB2YXIgczEsIHMyLCBlZTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBzMSA9IG5ldyBzdHJlYW0uUmVhZGFibGUoeyBvYmplY3RNb2RlOiB0cnVlLCByZWFkOiBzaW5vbi5zdHViKCkgfSk7XG4gICAgczIgPSBuZXcgc3RyZWFtLlRyYW5zZm9ybSh7IG9iamVjdE1vZGU6IHRydWUsIGhpZ2hXYXRlck1hcms6IDJ9KTtcbiAgICBzMi5fdHJhbnNmb3JtID0gKGQsIGUsIGNiKSA9PiBjYihudWxsLCBkKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ193cml0ZScsICgpID0+IHtcblxuICAgIGl0KCdjYWxscyB0aGUgY2FsbGJhY2sgaW1tZWRpYXRlbHkgaWYgdGhlIHdyaXRlIHF1ZXVlIGlzIG9wZW4nLCBkb25lID0+IHtcbiAgICAgIGFjdG9yLl93cml0ZShzMiwgJ2ZvbycpLnRoZW4oZG9uZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnY2FsbHMgdGhlIGNhbGxiYWNrIGFmdGVyIGRyYWluLCBpZiB0aGUgd3JpdGUgcXVldWUgaXMgZnVsbCcsIGRvbmUgPT4ge1xuXG4gICAgICBzMi53cml0ZSA9IHNpbm9uLnN0dWIoKTtcbiAgICAgIHMyLndyaXRlLnJldHVybnMoZmFsc2UpO1xuICAgICAgdmFyIHJlc29sdmVkID0gZmFsc2U7XG5cbiAgICAgIGFjdG9yXG4gICAgICAgIC5fd3JpdGUoczIsICdmb28nKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBleHBlY3QocmVzb2x2ZWQpLnRvLmJlLmZhbHNlO1xuICAgICAgICBzMi53cml0ZS5yZXR1cm5zKHRydWUpO1xuICAgICAgICBzMi5lbWl0KCdkcmFpbicpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdfY29uc3VtZScsICgpID0+IHtcbiAgICB2YXIgdHJhbnNmb3JtLCBlZTtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgYWN0b3IuX3dyaXRlID0gc2lub24uc3R1YigpLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKG51bGwpKTtcbiAgICAgIHRyYW5zZm9ybSA9IHNpbm9uLnN0dWIoKTtcbiAgICAgIGVlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2NhbGxzIHRyYW5zZm9ybSB3aXRoIGlucHV0IGZyb20gc3RyZWFtJywgZG9uZSA9PiB7XG4gICAgICB0cmFuc2Zvcm0ucmV0dXJucyhQcm9taXNlLnJlc29sdmUoe30pKVxuXG4gICAgICBzMS5wdXNoKCd1cmwxJyk7XG4gICAgICBhY3RvclxuICAgICAgICAuX2NvbnN1bWUoczEsIHMyLCB0cmFuc2Zvcm0sIGVlKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHRyYW5zZm9ybSkudG8uYmUuY2FsbGVkV2l0aCgndXJsMScpXG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdyZWN1cnNlcyBvbiBpdHNlbGYgd2l0aCBwYXNzZWQgcGFyYW1zIHdoaWxlIHRoZSBnb2luZyBpcyBnb29kJywgZG9uZSA9PiB7XG4gICAgICB0cmFuc2Zvcm0ucmV0dXJucyhQcm9taXNlLnJlc29sdmUoe3BhcmFtczogJ2ZvbycgfSkpXG5cbiAgICAgIHMxLnB1c2goJ3VybDEnKTtcbiAgICAgIHMxLnB1c2goJ3VybDInKTtcbiAgICAgIHMxLnB1c2gobnVsbCk7XG5cbiAgICAgIGFjdG9yXG4gICAgICAgIC5fY29uc3VtZShzMSwgczIsIHRyYW5zZm9ybSwgZWUpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICBleHBlY3QodHJhbnNmb3JtKS50by5oYXZlLmJlZW4uY2FsbGVkVHdpY2U7XG4gICAgICAgICAgZXhwZWN0KHRyYW5zZm9ybS5zZWNvbmRDYWxsLmFyZ3NbMV0pLnRvLmVxdWFsKCdmb28nKVxuICAgICAgICAgIGV4cGVjdCh0cmFuc2Zvcm0uc2Vjb25kQ2FsbC5hcmdzWzBdKS50by5lcXVhbCgndXJsMicpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgncmVqZWN0cyB3aGVuIHRyYW5zZm9ybSB0aHJvd3MnLCBkb25lID0+IHtcbiAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignZm9vJyk7XG4gICAgICB0cmFuc2Zvcm0ucmV0dXJucyhQcm9taXNlLnJlamVjdChlcnJvcikpXG4gICAgICBzMS5wdXNoKCd1cmwxJyk7XG4gICAgICBzMS5wdXNoKCd1cmwyJyk7XG4gICAgICBzMS5wdXNoKG51bGwpO1xuXG4gICAgICBhY3Rvci5fd3JpdGUgPSBzaW5vbi5zdHViKCk7XG5cbiAgICAgIGFjdG9yXG4gICAgICAgIC5fY29uc3VtZShzMSwgczIsIHRyYW5zZm9ybSwgZWUpXG4gICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIGV4cGVjdChhY3Rvci5fd3JpdGUpLnRvLm5vdC5oYXZlLmJlZW4uY2FsbGVkO1xuICAgICAgICAgIGV4cGVjdChlcnIpLnRvLmVxdWFsKGVycm9yKTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc3RhcnQnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBhY3Rvci5fY29uc3VtZSA9IHNpbm9uLnN0dWIoKTtcbiAgICB9KTtcblxuICAgIGl0KCdlbWl0cyBvbiBlbmQgZXZlbnQgb25seSBhZnRlciB0aGUgY29uc3VtZXIgcmVzb2x2ZXMgYXMgZmluaXNoZWQnLCBkb25lICA9PiB7XG4gICAgICB2YXIgcmVzb2x2ZTtcbiAgICAgIHZhciBwcm9taXNlID0gbmV3IFByb21pc2UoKF9yZXNvbHZlLCBfXykgPT4ge1xuICAgICAgICByZXNvbHZlID0gX3Jlc29sdmVcbiAgICAgIH0pO1xuXG4gICAgICBhY3Rvci5fY29uc3VtZS5yZXR1cm5zKHByb21pc2UpO1xuXG4gICAgICB2YXIgZW5kZWQgPSBmYWxzZTtcbiAgICAgIHZhciBlID0gYWN0b3Iuc3RhcnQoczEsIHMyKTtcbiAgICAgIGUub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgZW5kZWQgPSB0cnVlO1xuICAgICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICBleHBlY3QoZS5saXN0ZW5lckNvdW50KCdlbmQnKSkudG8uZXF1YWwoMCk7XG4gICAgICAgICAgZXhwZWN0KGUubGlzdGVuZXJDb3VudCgnZXJyb3InKSkudG8uZXF1YWwoMCk7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgZXhwZWN0KGVuZGVkKS50by5iZS5mYWxzZTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZW1pdHMgYW4gZXJyb3IgZXZlbnQgaWYgdGhlIGNvbnN1bWVyIHJlamVjdHMnLCBkb25lID0+IHtcbiAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignZm9vJyk7XG4gICAgICBhY3Rvci5fY29uc3VtZS5yZXR1cm5zKFByb21pc2UucmVqZWN0KGVycm9yKSk7XG5cbiAgICAgIHZhciBhID0gYWN0b3Iuc3RhcnQoczEsIHMyKTtcbiAgICAgIGEub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgZXhwZWN0KGVycikudG8uZXF1YWwoZXJyb3IpO1xuICAgICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICBleHBlY3QoYS5saXN0ZW5lckNvdW50KCdlcnJvcicpKS50by5lcXVhbCgwKVxuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdlbWl0cyBhbiBlcnJvciBldmVudCBpZiBjb25zdW1lciB0aHJvd3MgZm9yIGFueSByZWFzb24nLCBkb25lID0+IHtcbiAgICAgIGFjdG9yLl9jb25zdW1lLnRocm93cygpO1xuICAgICAgdmFyIGEgPSBhY3Rvci5zdGFydChzMSwgczIpO1xuICAgICAgYS5vbignZXJyb3InLCBlcnIgPT4ge1xuICAgICAgICBleHBlY3QoZXJyKS50by5iZS5hbignZXJyb3InKTtcbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KGEubGlzdGVuZXJDb3VudCgnZXJyb3InKSkudG8uZXF1YWwoMCk7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19