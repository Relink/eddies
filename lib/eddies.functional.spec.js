'use strict';

var chai = require('chai');
chai.use(require('sinon-chai'));
var Promise = require('bluebird');
var expect = chai.expect;
var sinon = require('sinon');
var _ = require('lodash');
var stream = require('stream');
var EventEmitter = require('events').EventEmitter;
var proxyquire = require('proxyquire');
var supervisor = require('./supervisor');

describe('eddies functional tests', function () {
  var s1, s2, config, transform;

  beforeEach(function () {
    s1 = new stream.Readable({ objectMode: true, highwaterMark: 2 });
    s1._read = sinon.stub();

    s2 = new stream.PassThrough({ objectMode: true, highWaterMark: 2 });

    config = {};
    transform = sinon.stub();
  });

  it('works with stops and restarts after success', function (done) {

    config = { number: 1 };
    transform.returns(Promise.resolve({ message: 'foo' }));
    var finishStub = sinon.stub();
    var successStub = sinon.stub();

    console.log(supervisor);
    s1.pipe(supervisor.start(config, transform)).on('error', function (err) {
      return expect(err).not.to.exist;
    }).on('eddies:success', successStub).on('eddies:finish', finishStub).pipe(s2);

    // simulate single input
    s1.push(1);
    setTimeout(function () {

      // should finish due to reaching end of input
      expect(s2.read()).to.equal('foo');
      expect(successStub).to.have.been.calledOnce;
      expect(finishStub).to.have.been.calledOnce;

      s1.push(2);

      setTimeout(function () {
        // Should continue to read.
        expect(s2.read()).to.equal('foo');
        expect(successStub).to.have.been.calledTwice;
        expect(finishStub).to.have.been.calledTwice;
        done();
      }, 30);
    }, 30);
  });

  it('works with stops and restarts after errors', function (done) {

    config = { number: 1 };
    transform.returns(Promise.reject(new Error('foo')));
    var finishStub = sinon.stub();
    var successStub = sinon.stub();
    var warnStub = sinon.stub();

    s1.pipe(supervisor.start(config, transform)).on('error', function (err) {
      return expect(err).not.to.exist;
    }).on('eddies:warn', warnStub).on('eddies:success', successStub).on('eddies:finish', finishStub).pipe(s2);

    // simulate single input that will error due to
    // transform stub:
    s1.push(1);
    setTimeout(function () {

      // should finish due to reaching end of input
      expect(s2.read()).to.equal(null);
      expect(warnStub).to.have.been.calledOnce;
      expect(finishStub).to.have.been.calledOnce;

      // send a message that does not error
      transform.returns(Promise.resolve({ message: 'foo' }));
      s1.push(2);

      setTimeout(function () {
        // Should continue to read.
        expect(s2.read()).to.equal('foo');
        expect(successStub).to.have.been.calledOnce;
        expect(finishStub).to.have.been.calledTwice;
        done();
      }, 30);
    }, 30);
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lZGRpZXMuZnVuY3Rpb25hbC5zcGVjLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxPQUFPLFFBQVEsTUFBUixDQUFQO0FBQ0osS0FBSyxHQUFMLENBQVMsUUFBUSxZQUFSLENBQVQ7QUFDQSxJQUFJLFVBQVUsUUFBUSxVQUFSLENBQVY7QUFDSixJQUFJLFNBQVMsS0FBSyxNQUFMO0FBQ2IsSUFBSSxRQUFRLFFBQVEsT0FBUixDQUFSO0FBQ0osSUFBSSxJQUFJLFFBQVEsUUFBUixDQUFKO0FBQ0osSUFBSSxTQUFTLFFBQVEsUUFBUixDQUFUO0FBQ0osSUFBSSxlQUFlLFFBQVEsUUFBUixFQUFrQixZQUFsQjtBQUNuQixJQUFJLGFBQWEsUUFBUSxZQUFSLENBQWI7QUFDSixJQUFJLGFBQWEsUUFBUSxjQUFSLENBQWI7O0FBRUosU0FBUyx5QkFBVCxFQUFvQyxZQUFNO0FBQ3hDLE1BQUksRUFBSixFQUFRLEVBQVIsRUFBWSxNQUFaLEVBQW9CLFNBQXBCLENBRHdDOztBQUd4QyxhQUFXLFlBQU07QUFDZixTQUFLLElBQUksT0FBTyxRQUFQLENBQWdCLEVBQUUsWUFBWSxJQUFaLEVBQWtCLGVBQWUsQ0FBZixFQUF4QyxDQUFMLENBRGU7QUFFZixPQUFHLEtBQUgsR0FBVyxNQUFNLElBQU4sRUFBWCxDQUZlOztBQUlmLFNBQUssSUFBSSxPQUFPLFdBQVAsQ0FBbUIsRUFBRSxZQUFZLElBQVosRUFBa0IsZUFBZSxDQUFmLEVBQTNDLENBQUwsQ0FKZTs7QUFNZixhQUFTLEVBQVQsQ0FOZTtBQU9mLGdCQUFZLE1BQU0sSUFBTixFQUFaLENBUGU7R0FBTixDQUFYLENBSHdDOztBQWF4QyxLQUFHLDZDQUFILEVBQWtELGdCQUFROztBQUV4RCxhQUFTLEVBQUUsUUFBUSxDQUFSLEVBQVgsQ0FGd0Q7QUFHeEQsY0FBVSxPQUFWLENBQWtCLFFBQVEsT0FBUixDQUFnQixFQUFFLFNBQVMsS0FBVCxFQUFsQixDQUFsQixFQUh3RDtBQUl4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QVdmLGlCQUFXLFlBQU07O0FBRWYsZUFBTyxHQUFHLElBQUgsRUFBUCxFQUFrQixFQUFsQixDQUFxQixLQUFyQixDQUEyQixLQUEzQixFQUZlO0FBR2YsZUFBTyxXQUFQLEVBQW9CLEVBQXBCLENBQXVCLElBQXZCLENBQTRCLElBQTVCLENBQWlDLFVBQWpDLENBSGU7QUFJZixlQUFPLFVBQVAsRUFBbUIsRUFBbkIsQ0FBc0IsSUFBdEIsQ0FBMkIsSUFBM0IsQ0FBZ0MsV0FBaEMsQ0FKZTtBQUtmLGVBTGU7T0FBTixFQU1SLEVBTkgsRUFYZTtLQUFOLEVBbUJSLEVBbkJILEVBbkJ1RDtHQUFSLENBQWpELENBbER3QztDQUFOLENBQXBDIiwiZmlsZSI6ImVkZGllcy5mdW5jdGlvbmFsLnNwZWMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgY2hhaSA9IHJlcXVpcmUoJ2NoYWknKTtcbmNoYWkudXNlKHJlcXVpcmUoJ3Npbm9uLWNoYWknKSk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG52YXIgZXhwZWN0ID0gY2hhaS5leHBlY3Q7XG52YXIgc2lub24gPSByZXF1aXJlKCdzaW5vbicpO1xudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG52YXIgcHJveHlxdWlyZSA9IHJlcXVpcmUoJ3Byb3h5cXVpcmUnKTtcbnZhciBzdXBlcnZpc29yID0gcmVxdWlyZSgnLi9zdXBlcnZpc29yJyk7XG5cbmRlc2NyaWJlKCdlZGRpZXMgZnVuY3Rpb25hbCB0ZXN0cycsICgpID0+IHtcbiAgdmFyIHMxLCBzMiwgY29uZmlnLCB0cmFuc2Zvcm07XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgczEgPSBuZXcgc3RyZWFtLlJlYWRhYmxlKHsgb2JqZWN0TW9kZTogdHJ1ZSwgaGlnaHdhdGVyTWFyazogMiB9KTtcbiAgICBzMS5fcmVhZCA9IHNpbm9uLnN0dWIoKTtcblxuICAgIHMyID0gbmV3IHN0cmVhbS5QYXNzVGhyb3VnaCh7IG9iamVjdE1vZGU6IHRydWUsIGhpZ2hXYXRlck1hcms6IDJ9KTtcblxuICAgIGNvbmZpZyA9IHt9O1xuICAgIHRyYW5zZm9ybSA9IHNpbm9uLnN0dWIoKTtcbiAgfSk7XG5cbiAgaXQoJ3dvcmtzIHdpdGggc3RvcHMgYW5kIHJlc3RhcnRzIGFmdGVyIHN1Y2Nlc3MnLCBkb25lID0+IHtcblxuICAgIGNvbmZpZyA9IHsgbnVtYmVyOiAxIH07XG4gICAgdHJhbnNmb3JtLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKHsgbWVzc2FnZTogJ2ZvbycgfSkpO1xuICAgIHZhciBmaW5pc2hTdHViID0gc2lub24uc3R1YigpO1xuICAgIHZhciBzdWNjZXNzU3R1YiA9IHNpbm9uLnN0dWIoKTtcblxuICAgIGNvbnNvbGUubG9nKHN1cGVydmlzb3IpXG4gICAgczFcbiAgICAgIC5waXBlKHN1cGVydmlzb3Iuc3RhcnQoY29uZmlnLCB0cmFuc2Zvcm0pKVxuICAgICAgLm9uKCdlcnJvcicsIGVyciA9PiBleHBlY3QoZXJyKS5ub3QudG8uZXhpc3QpXG4gICAgICAub24oJ2VkZGllczpzdWNjZXNzJywgc3VjY2Vzc1N0dWIpXG4gICAgICAub24oJ2VkZGllczpmaW5pc2gnLCBmaW5pc2hTdHViKVxuICAgICAgLnBpcGUoczIpXG5cbiAgICAvLyBzaW11bGF0ZSBzaW5nbGUgaW5wdXRcbiAgICBzMS5wdXNoKDEpO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgICAvLyBzaG91bGQgZmluaXNoIGR1ZSB0byByZWFjaGluZyBlbmQgb2YgaW5wdXRcbiAgICAgIGV4cGVjdChzMi5yZWFkKCkpLnRvLmVxdWFsKCdmb28nKTtcbiAgICAgIGV4cGVjdChzdWNjZXNzU3R1YikudG8uaGF2ZS5iZWVuLmNhbGxlZE9uY2U7XG4gICAgICBleHBlY3QoZmluaXNoU3R1YikudG8uaGF2ZS5iZWVuLmNhbGxlZE9uY2U7XG5cbiAgICAgIHMxLnB1c2goMik7XG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAvLyBTaG91bGQgY29udGludWUgdG8gcmVhZC5cbiAgICAgICAgZXhwZWN0KHMyLnJlYWQoKSkudG8uZXF1YWwoJ2ZvbycpO1xuICAgICAgICBleHBlY3Qoc3VjY2Vzc1N0dWIpLnRvLmhhdmUuYmVlbi5jYWxsZWRUd2ljZTtcbiAgICAgICAgZXhwZWN0KGZpbmlzaFN0dWIpLnRvLmhhdmUuYmVlbi5jYWxsZWRUd2ljZTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSwgMzApXG5cbiAgICB9LCAzMCk7XG4gIH0pO1xuXG4gIGl0KCd3b3JrcyB3aXRoIHN0b3BzIGFuZCByZXN0YXJ0cyBhZnRlciBlcnJvcnMnLCBkb25lID0+IHtcblxuICAgIGNvbmZpZyA9IHsgbnVtYmVyOiAxIH07XG4gICAgdHJhbnNmb3JtLnJldHVybnMoUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdmb28nKSkpO1xuICAgIHZhciBmaW5pc2hTdHViID0gc2lub24uc3R1YigpO1xuICAgIHZhciBzdWNjZXNzU3R1YiA9IHNpbm9uLnN0dWIoKTtcbiAgICB2YXIgd2FyblN0dWIgPSBzaW5vbi5zdHViKCk7XG5cbiAgICBzMVxuICAgICAgLnBpcGUoc3VwZXJ2aXNvci5zdGFydChjb25maWcsIHRyYW5zZm9ybSkpXG4gICAgICAub24oJ2Vycm9yJywgZXJyID0+IGV4cGVjdChlcnIpLm5vdC50by5leGlzdClcbiAgICAgIC5vbignZWRkaWVzOndhcm4nLCB3YXJuU3R1YilcbiAgICAgIC5vbignZWRkaWVzOnN1Y2Nlc3MnLCBzdWNjZXNzU3R1YilcbiAgICAgIC5vbignZWRkaWVzOmZpbmlzaCcsIGZpbmlzaFN0dWIpXG4gICAgICAucGlwZShzMilcblxuICAgIC8vIHNpbXVsYXRlIHNpbmdsZSBpbnB1dCB0aGF0IHdpbGwgZXJyb3IgZHVlIHRvXG4gICAgLy8gdHJhbnNmb3JtIHN0dWI6XG4gICAgczEucHVzaCgxKTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgICAgLy8gc2hvdWxkIGZpbmlzaCBkdWUgdG8gcmVhY2hpbmcgZW5kIG9mIGlucHV0XG4gICAgICBleHBlY3QoczIucmVhZCgpKS50by5lcXVhbChudWxsKTtcbiAgICAgIGV4cGVjdCh3YXJuU3R1YikudG8uaGF2ZS5iZWVuLmNhbGxlZE9uY2U7XG4gICAgICBleHBlY3QoZmluaXNoU3R1YikudG8uaGF2ZS5iZWVuLmNhbGxlZE9uY2U7XG5cbiAgICAgIC8vIHNlbmQgYSBtZXNzYWdlIHRoYXQgZG9lcyBub3QgZXJyb3JcbiAgICAgIHRyYW5zZm9ybS5yZXR1cm5zKFByb21pc2UucmVzb2x2ZSh7IG1lc3NhZ2U6ICdmb28nIH0pKVxuICAgICAgczEucHVzaCgyKTtcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIC8vIFNob3VsZCBjb250aW51ZSB0byByZWFkLlxuICAgICAgICBleHBlY3QoczIucmVhZCgpKS50by5lcXVhbCgnZm9vJyk7XG4gICAgICAgIGV4cGVjdChzdWNjZXNzU3R1YikudG8uaGF2ZS5iZWVuLmNhbGxlZE9uY2U7XG4gICAgICAgIGV4cGVjdChmaW5pc2hTdHViKS50by5oYXZlLmJlZW4uY2FsbGVkVHdpY2U7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0sIDMwKVxuXG4gICAgfSwgMzApO1xuICB9KTtcbn0pO1xuIl19