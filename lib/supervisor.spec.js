'use strict';

var chai = require('chai');
chai.use(require('sinon-chai'));
var Promise = require('bluebird');
var expect = chai.expect;
var sinon = require('sinon');
var _ = require('lodash');
var stream = require('stream');
var EventEmitter = require('events').EventEmitter;
var proxyquire = require('proxyquire');

var actorMock = {
  start: sinon.stub()
};

var supervisor = proxyquire('./supervisor', {
  './actor': actorMock
});

describe('supervisor', function () {
  var s1, s2, s3, s4, config, transform;

  beforeEach(function () {
    s1 = new stream.Readable({ objectMode: true, highwaterMark: 2 });
    s1._read = sinon.stub();

    s2 = new stream.Transform({ objectMode: true, highWaterMark: 2 });
    s2._transform = function (d, e, cb) {
      return cb(null, d);
    };

    s3 = new stream.Writable({ objectMode: true });
    s3._write = function () {
      return true;
    };

    s4 = new stream.Duplex({ objectMode: true, highWaterMark: 2,
      read: sinon.stub(), write: sinon.stub() });

    config = {};
    transform = sinon.stub();

    actorMock.start.reset();
  });

  describe('_trackErrors', function () {
    it('does not throw if successes come', function () {
      var ee = new EventEmitter();
      supervisor._trackErrors(2, ee);
      ee.emit('warn');
      ee.emit('warn');
      ee.emit('success');
      ee.emit('warn');
    });

    it('throws if more errors than number given', function () {
      var ee = new EventEmitter();
      supervisor._trackErrors(1, ee);
      ee.emit('warn');
      expect(ee.emit.bind(ee, 'warn')).to.throw();
    });
  });

  describe('_startActors', function () {
    var errorCb, endCb, e1, errorEmitter;

    beforeEach(function () {
      errorCb = sinon.stub();
      endCb = sinon.stub();
      e1 = new EventEmitter();
      errorEmitter = new EventEmitter();
    });

    it('recycles, restarts, and reports an error', function (done) {
      var error = new Error('foo');
      error.originalInput = 'bar';
      actorMock.start.returns(e1);

      sinon.stub(s3, 'write', function () {
        return true;
      });

      errorEmitter.on('warn', function (err) {
        expect(err).to.be.an('error');

        // give next tick so actor.start gets called again
        process.nextTick(function () {
          expect(s3.write).to.have.been.calledWith('bar');
          expect(actorMock.start).to.have.been.calledTwice;
          expect(actorMock.start.firstCall.args).to.deep.equal([s1, s2, transform]);
          done();
        });
      });

      supervisor._startActors(1, s1, s2, errorEmitter, transform, { rc: s3 }, endCb);
      e1.emit('error', error);
    });

    it('asynchronously starts the number of actors it is asked to start', function (done) {
      actorMock.start.returns(e1);
      supervisor._startActors(4, s1, s2, errorEmitter, transform, config, endCb);
      setTimeout(function () {
        expect(actorMock.start.callCount).to.equal(4);
        done();
      }, 20);
    });

    it('handles errors even when no rc given', function (done) {
      actorMock.start.returns(e1);
      supervisor._startActors(1, s1, s2, errorEmitter, transform, config, endCb);
      errorEmitter.on('warn', function (err) {
        expect(err).to.be.an.error;
        done();
      });
      e1.emit('error', new Error('foo'));
    });
  });

  describe('_runProxies', function () {
    var endCb;

    before(function () {
      var startActorMock = function startActorMock(num, src, dest, rc, ee, config, _endCb) {
        endCb = _endCb;
      };
      sinon.stub(supervisor, '_startActors', startActorMock);
    });

    after(function () {
      return supervisor._startActors.restore();
    });

    it('does not resolve until endCb called enough times', function (done) {
      var resolved = false;

      supervisor._runProxies(s1, s2, s4, transform, { number: 2, errorCount: 1 }).then(function (res) {
        resolved = true;
      });

      endCb();
      setTimeout(function () {
        expect(resolved).to.be.false;
        done();
      });
    });

    it('resolves when the endCb is called and it has called startActors', function (done) {
      var resolved = false;
      supervisor._runProxies(s1, s2, s4, transform, { number: 3, errorCount: 1 }).then(function (res) {
        resolved = true;
        expect(supervisor._startActors).to.have.been.calledWith(3);
        done();
      });
      endCb();
      endCb();
      endCb();
      expect(resolved).to.be.false;
    });
  });

  describe('start', function () {

    before(function () {
      return sinon.stub(supervisor, '_runProxies');
    });
    beforeEach(function () {
      return supervisor._runProxies.reset();
    });
    after(function () {
      return supervisor._runProxies.restore();
    });

    it('propogates errors to returned stream', function (done) {
      supervisor._runProxies.returns(Promise.reject(new Error('foo')));
      supervisor.start(config, transform, s1, s2, s3).on('error', function (err) {
        expect(err).to.be.an.error;
        done();
      });
      s1.push(1);
    });

    it('removes the listener so that it doesnt call runProxies more than once', function (done) {
      supervisor._runProxies.returns(new Promise(function (resolve, reject) {
        return true;
      }));
      supervisor.start(config, transform, s1, s2, s3);
      s1.push(1);
      s1.push(2);
      process.nextTick(function () {
        s1.push(3);
        process.nextTick(function () {
          expect(supervisor._runProxies).to.have.been.calledOnce;
          done();
        });
      });
    });

    it('adds a listener to restart after runProxies finishes', function (done) {
      var resolve;
      supervisor._runProxies.returns(new Promise(function (_resolve, reject) {
        return resolve = _resolve;
      }));
      var stream = supervisor.start(config, transform, s1, s2, s3);
      expect(supervisor._runProxies).not.to.have.been.called;
      s1.push(1);

      // this setTimeout simulates the first readable event
      setTimeout(function () {
        expect(supervisor._runProxies).to.have.been.calledOnce;

        // By reading the queue empty, we create the conditions for the
        // readable event to fire again.
        s1.read();
        resolve();
        setTimeout(function () {

          // After we have resolved the promise, simulating the finish of the proxy
          // actors, we push more data onto the queue, simulating new data. This
          // triggers a new readable evetn.
          s1.push(2);

          setTimeout(function () {
            expect(supervisor._runProxies.callCount).to.equal(2);
            done();
          });
        });
      });
    });

    it('returns a readable stream', function (done) {
      var stream = supervisor.start(s3, config);

      stream.on('readable', function () {
        expect(stream.read()).to.equal(1);
        expect(stream.read()).to.equal(2);
        done();
      });

      stream.push(1);
      stream.push(2);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXBlcnZpc29yLnNwZWMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJLE9BQU8sUUFBUSxNQUFSLENBQVA7QUFDSixLQUFLLEdBQUwsQ0FBUyxRQUFRLFlBQVIsQ0FBVDtBQUNBLElBQUksVUFBVSxRQUFRLFVBQVIsQ0FBVjtBQUNKLElBQUksU0FBUyxLQUFLLE1BQUw7QUFDYixJQUFJLFFBQVEsUUFBUSxPQUFSLENBQVI7QUFDSixJQUFJLElBQUksUUFBUSxRQUFSLENBQUo7QUFDSixJQUFJLFNBQVMsUUFBUSxRQUFSLENBQVQ7QUFDSixJQUFJLGVBQWUsUUFBUSxRQUFSLEVBQWtCLFlBQWxCO0FBQ25CLElBQUksYUFBYSxRQUFRLFlBQVIsQ0FBYjs7QUFFSixJQUFJLFlBQVk7QUFDZCxTQUFPLE1BQU0sSUFBTixFQUFQO0NBREU7O0FBSUosSUFBSSxhQUFhLFdBQVcsY0FBWCxFQUEyQjtBQUMxQyxhQUFXLFNBQVg7Q0FEZSxDQUFiOztBQUlKLFNBQVMsWUFBVCxFQUF1QixZQUFNO0FBQzNCLE1BQUksRUFBSixFQUFRLEVBQVIsRUFBWSxFQUFaLEVBQWdCLEVBQWhCLEVBQW9CLE1BQXBCLEVBQTRCLFNBQTVCLENBRDJCOztBQUczQixhQUFXLFlBQU07QUFDZixTQUFLLElBQUksT0FBTyxRQUFQLENBQWdCLEVBQUUsWUFBWSxJQUFaLEVBQWtCLGVBQWUsQ0FBZixFQUF4QyxDQUFMLENBRGU7QUFFZixPQUFHLEtBQUgsR0FBVyxNQUFNLElBQU4sRUFBWCxDQUZlOztBQUlmLFNBQUssSUFBSSxPQUFPLFNBQVAsQ0FBaUIsRUFBRSxZQUFZLElBQVosRUFBa0IsZUFBZSxDQUFmLEVBQXpDLENBQUwsQ0FKZTtBQUtmLE9BQUcsVUFBSCxHQUFnQixVQUFDLENBQUQsRUFBSSxDQUFKLEVBQU8sRUFBUDthQUFjLEdBQUcsSUFBSCxFQUFTLENBQVQ7S0FBZCxDQUxEOztBQU9mLFNBQUssSUFBSSxPQUFPLFFBQVAsQ0FBZ0IsRUFB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K0IsRUFBL0IsQ0FBa0MsSUFBbEMsQ0FBdUMsSUFBdkMsQ0FBNEMsVUFBNUM7Ozs7QUFEZSxVQUtmLENBQUcsSUFBSCxHQUxlO0FBTWYsa0JBTmU7QUFPZixtQkFBVyxZQUFNOzs7OztBQUtmLGFBQUcsSUFBSCxDQUFRLENBQVIsRUFMZTs7QUFPZixxQkFBVyxZQUFNO0FBQ2YsbUJBQU8sV0FBVyxXQUFYLENBQXVCLFNBQXZCLENBQVAsQ0FBeUMsRUFBekMsQ0FBNEMsS0FBNUMsQ0FBa0QsQ0FBbEQsRUFEZTtBQUVmLG1CQUZlO1dBQU4sQ0FBWCxDQVBlO1NBQU4sQ0FBWCxDQVBlO09BQU4sQ0FBWCxDQVJpRTtLQUFSLENBQTNELENBOUJzQjs7QUE4RHRCLE9BQUcsMkJBQUgsRUFBZ0MsZ0JBQVE7QUFDdEMsVUFBSSxTQUFTLFdBQVcsS0FBWCxDQUFpQixFQUFqQixFQUFxQixNQUFyQixDQUFULENBRGtDOztBQUd0QyxhQUFPLEVBQVAsQ0FBVSxVQUFWLEVBQXNCLFlBQU07QUFDMUIsZUFBTyxPQUFPLElBQVAsRUFBUCxFQUFzQixFQUF0QixDQUF5QixLQUF6QixDQUErQixDQUEvQixFQUQwQjtBQUUxQixlQUFPLE9BQU8sSUFBUCxFQUFQLEVBQXNCLEVBQXRCLENBQXlCLEtBQXpCLENBQStCLENBQS9CLEVBRjBCO0FBRzFCLGVBSDBCO09BQU4sQ0FBdEIsQ0FIc0M7O0FBU3RDLGFBQU8sSUFBUCxDQUFZLENBQVosRUFUc0M7QUFVdEMsYUFBTyxJQUFQLENBQVksQ0FBWixFQVZzQztLQUFSLENBQWhDLENBOURzQjtHQUFOLENBQWxCLENBekkyQjtDQUFOLENBQXZCIiwiZmlsZSI6InN1cGVydmlzb3Iuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBjaGFpID0gcmVxdWlyZSgnY2hhaScpO1xuY2hhaS51c2UocmVxdWlyZSgnc2lub24tY2hhaScpKTtcbnZhciBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbnZhciBleHBlY3QgPSBjaGFpLmV4cGVjdDtcbnZhciBzaW5vbiA9IHJlcXVpcmUoJ3Npbm9uJyk7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1xudmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjtcbnZhciBwcm94eXF1aXJlID0gcmVxdWlyZSgncHJveHlxdWlyZScpO1xuXG52YXIgYWN0b3JNb2NrID0ge1xuICBzdGFydDogc2lub24uc3R1YigpXG59O1xuXG52YXIgc3VwZXJ2aXNvciA9IHByb3h5cXVpcmUoJy4vc3VwZXJ2aXNvcicsIHtcbiAgJy4vYWN0b3InOiBhY3Rvck1vY2tcbn0pO1xuXG5kZXNjcmliZSgnc3VwZXJ2aXNvcicsICgpID0+IHtcbiAgdmFyIHMxLCBzMiwgczMsIHM0LCBjb25maWcsIHRyYW5zZm9ybTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBzMSA9IG5ldyBzdHJlYW0uUmVhZGFibGUoeyBvYmplY3RNb2RlOiB0cnVlLCBoaWdod2F0ZXJNYXJrOiAyIH0pO1xuICAgIHMxLl9yZWFkID0gc2lub24uc3R1YigpO1xuXG4gICAgczIgPSBuZXcgc3RyZWFtLlRyYW5zZm9ybSh7IG9iamVjdE1vZGU6IHRydWUsIGhpZ2hXYXRlck1hcms6IDJ9KTtcbiAgICBzMi5fdHJhbnNmb3JtID0gKGQsIGUsIGNiKSA9PiBjYihudWxsLCBkKTtcblxuICAgIHMzID0gbmV3IHN0cmVhbS5Xcml0YWJsZSh7IG9iamVjdE1vZGU6IHRydWUgfSk7XG4gICAgczMuX3dyaXRlID0gKCkgPT4geyByZXR1cm4gdHJ1ZSB9O1xuXG4gICAgczQgPSBuZXcgc3RyZWFtLkR1cGxleCh7IG9iamVjdE1vZGU6IHRydWUsIGhpZ2hXYXRlck1hcms6IDIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWQ6IHNpbm9uLnN0dWIoKSwgd3JpdGU6IHNpbm9uLnN0dWIoKX0pXG5cbiAgICBjb25maWcgPSB7fTtcbiAgICB0cmFuc2Zvcm0gPSBzaW5vbi5zdHViKCk7XG5cbiAgICBhY3Rvck1vY2suc3RhcnQucmVzZXQoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ190cmFja0Vycm9ycycsICgpID0+IHtcbiAgICBpdCgnZG9lcyBub3QgdGhyb3cgaWYgc3VjY2Vzc2VzIGNvbWUnLCAoKSA9PiB7XG4gICAgICB2YXIgZWUgPSBuZXcgRXZlbnRFbWl0dGVyKClcbiAgICAgIHN1cGVydmlzb3IuX3RyYWNrRXJyb3JzKDIsIGVlKVxuICAgICAgZWUuZW1pdCgnd2FybicpO1xuICAgICAgZWUuZW1pdCgnd2FybicpO1xuICAgICAgZWUuZW1pdCgnc3VjY2VzcycpO1xuICAgICAgZWUuZW1pdCgnd2FybicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Rocm93cyBpZiBtb3JlIGVycm9ycyB0aGFuIG51bWJlciBnaXZlbicsICgpID0+IHtcbiAgICAgIHZhciBlZSA9IG5ldyBFdmVudEVtaXR0ZXIoKVxuICAgICAgc3VwZXJ2aXNvci5fdHJhY2tFcnJvcnMoMSwgZWUpXG4gICAgICBlZS5lbWl0KCd3YXJuJyk7XG4gICAgICBleHBlY3QoZWUuZW1pdC5iaW5kKGVlLCAnd2FybicpKS50by50aHJvdygpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnX3N0YXJ0QWN0b3JzJywgKCkgPT4ge1xuICAgIHZhciBlcnJvckNiLCBlbmRDYiwgZTEsIGVycm9yRW1pdHRlcjtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgZXJyb3JDYiA9IHNpbm9uLnN0dWIoKTtcbiAgICAgIGVuZENiID0gc2lub24uc3R1YigpO1xuICAgICAgZTEgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgICBlcnJvckVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgfSk7XG5cbiAgICBpdCgncmVjeWNsZXMsIHJlc3RhcnRzLCBhbmQgcmVwb3J0cyBhbiBlcnJvcicsIGRvbmUgPT4ge1xuICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCdmb28nKTtcbiAgICAgIGVycm9yLm9yaWdpbmFsSW5wdXQgPSAnYmFyJztcbiAgICAgIGFjdG9yTW9jay5zdGFydC5yZXR1cm5zKGUxKTtcblxuICAgICAgc2lub24uc3R1YihzMywgJ3dyaXRlJywgKCkgPT4gdHJ1ZSk7XG5cbiAgICAgIGVycm9yRW1pdHRlci5vbignd2FybicsIGVyciA9PiB7XG4gICAgICAgIGV4cGVjdChlcnIpLnRvLmJlLmFuKCdlcnJvcicpO1xuXG4gICAgICAgIC8vIGdpdmUgbmV4dCB0aWNrIHNvIGFjdG9yLnN0YXJ0IGdldHMgY2FsbGVkIGFnYWluXG4gICAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICAgIGV4cGVjdChzMy53cml0ZSkudG8uaGF2ZS5iZWVuLmNhbGxlZFdpdGgoJ2JhcicpO1xuICAgICAgICAgIGV4cGVjdChhY3Rvck1vY2suc3RhcnQpLnRvLmhhdmUuYmVlbi5jYWxsZWRUd2ljZTtcbiAgICAgICAgICBleHBlY3QoYWN0b3JNb2NrLnN0YXJ0LmZpcnN0Q2FsbC5hcmdzKVxuICAgICAgICAgICAgLnRvLmRlZXAuZXF1YWwoW3MxLCBzMiwgdHJhbnNmb3JtXSlcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIHN1cGVydmlzb3IuX3N0YXJ0QWN0b3JzKDEsIHMxLCBzMiwgZXJyb3JFbWl0dGVyLCB0cmFuc2Zvcm0sIHtyYzogczN9LCBlbmRDYik7XG4gICAgICBlMS5lbWl0KCdlcnJvcicsIGVycm9yKTtcbiAgICB9KTtcblxuICAgIGl0KCdhc3luY2hyb25vdXNseSBzdGFydHMgdGhlIG51bWJlciBvZiBhY3RvcnMgaXQgaXMgYXNrZWQgdG8gc3RhcnQnLCBkb25lID0+IHtcbiAgICAgIGFjdG9yTW9jay5zdGFydC5yZXR1cm5zKGUxKTtcbiAgICAgIHN1cGVydmlzb3IuX3N0YXJ0QWN0b3JzKDQsIHMxLCBzMiwgZXJyb3JFbWl0dGVyLCB0cmFuc2Zvcm0sIGNvbmZpZywgZW5kQ2IpO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChhY3Rvck1vY2suc3RhcnQuY2FsbENvdW50KS50by5lcXVhbCg0KTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSwgMjApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2hhbmRsZXMgZXJyb3JzIGV2ZW4gd2hlbiBubyByYyBnaXZlbicsIGRvbmUgPT4ge1xuICAgICAgYWN0b3JNb2NrLnN0YXJ0LnJldHVybnMoZTEpO1xuICAgICAgc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMoMSwgczEsIHMyLCBlcnJvckVtaXR0ZXIsIHRyYW5zZm9ybSwgY29uZmlnLCBlbmRDYik7XG4gICAgICBlcnJvckVtaXR0ZXIub24oJ3dhcm4nLCBlcnIgPT4ge1xuICAgICAgICBleHBlY3QoZXJyKS50by5iZS5hbi5lcnJvcjtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgICBlMS5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignZm9vJykpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnX3J1blByb3hpZXMnLCAoKSA9PiB7XG4gICAgdmFyIGVuZENiO1xuXG4gICAgYmVmb3JlKCgpID0+IHtcbiAgICAgIHZhciBzdGFydEFjdG9yTW9jayA9IGZ1bmN0aW9uIChudW0sIHNyYywgZGVzdCwgcmMsIGVlLCBjb25maWcsIF9lbmRDYil7XG4gICAgICAgIGVuZENiID0gX2VuZENiO1xuICAgICAgfVxuICAgICAgc2lub24uc3R1YihzdXBlcnZpc29yLCAnX3N0YXJ0QWN0b3JzJywgc3RhcnRBY3Rvck1vY2spO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXIoKCkgPT4gc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMucmVzdG9yZSgpKVxuXG4gICAgaXQoJ2RvZXMgbm90IHJlc29sdmUgdW50aWwgZW5kQ2IgY2FsbGVkIGVub3VnaCB0aW1lcycsIGRvbmUgPT4ge1xuICAgICAgdmFyIHJlc29sdmVkID0gZmFsc2U7XG5cbiAgICAgIHN1cGVydmlzb3IuX3J1blByb3hpZXMoczEsIHMyLCBzNCwgdHJhbnNmb3JtLCB7bnVtYmVyOiAyLCBlcnJvckNvdW50OiAxfSlcbiAgICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICByZXNvbHZlZCA9IHRydWU7XG4gICAgICAgIH0pO1xuXG4gICAgICBlbmRDYigpO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXNvbHZlZCkudG8uYmUuZmFsc2U7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Jlc29sdmVzIHdoZW4gdGhlIGVuZENiIGlzIGNhbGxlZCBhbmQgaXQgaGFzIGNhbGxlZCBzdGFydEFjdG9ycycsIGRvbmUgID0+IHtcbiAgICAgIHZhciByZXNvbHZlZCA9IGZhbHNlO1xuICAgICAgc3VwZXJ2aXNvci5fcnVuUHJveGllcyhzMSwgczIsIHM0LCB0cmFuc2Zvcm0sIHtudW1iZXI6IDMsIGVycm9yQ291bnQ6IDF9KVxuICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTtcbiAgICAgICAgICBleHBlY3Qoc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMpLnRvLmhhdmUuYmVlbi5jYWxsZWRXaXRoKDMpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSlcbiAgICAgIGVuZENiKCk7XG4gICAgICBlbmRDYigpO1xuICAgICAgZW5kQ2IoKTtcbiAgICAgIGV4cGVjdChyZXNvbHZlZCkudG8uYmUuZmFsc2U7XG4gICAgfSk7XG4gIH0pO1xuXG5cbiAgZGVzY3JpYmUoJ3N0YXJ0JywgKCkgPT4ge1xuXG4gICAgYmVmb3JlKCgpID0+IHNpbm9uLnN0dWIoc3VwZXJ2aXNvciwgJ19ydW5Qcm94aWVzJykpO1xuICAgIGJlZm9yZUVhY2goKCkgPT4gc3VwZXJ2aXNvci5fcnVuUHJveGllcy5yZXNldCgpKTtcbiAgICBhZnRlcigoKSA9PiBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJlc3RvcmUoKSk7XG5cbiAgICBpdCgncHJvcG9nYXRlcyBlcnJvcnMgdG8gcmV0dXJuZWQgc3RyZWFtJywgZG9uZSA9PiB7XG4gICAgICBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJldHVybnMoUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdmb28nKSkpO1xuICAgICAgc3VwZXJ2aXNvci5zdGFydChjb25maWcsIHRyYW5zZm9ybSwgczEsIHMyLCBzMylcbiAgICAgICAgLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICAgICAgZXhwZWN0KGVycikudG8uYmUuYW4uZXJyb3I7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIHMxLnB1c2goMSlcbiAgICB9KTtcblxuICAgIGl0KCdyZW1vdmVzIHRoZSBsaXN0ZW5lciBzbyB0aGF0IGl0IGRvZXNudCBjYWxsIHJ1blByb3hpZXMgbW9yZSB0aGFuIG9uY2UnLCBkb25lID0+IHtcbiAgICAgIHN1cGVydmlzb3IuX3J1blByb3hpZXMucmV0dXJucyhuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0cnVlKSk7XG4gICAgICBzdXBlcnZpc29yLnN0YXJ0KGNvbmZpZywgdHJhbnNmb3JtLCBzMSwgczIsIHMzKTtcbiAgICAgIHMxLnB1c2goMSk7XG4gICAgICBzMS5wdXNoKDIpO1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIHMxLnB1c2goMyk7XG4gICAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICAgIGV4cGVjdChzdXBlcnZpc29yLl9ydW5Qcm94aWVzKS50by5oYXZlLmJlZW4uY2FsbGVkT25jZTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnYWRkcyBhIGxpc3RlbmVyIHRvIHJlc3RhcnQgYWZ0ZXIgcnVuUHJveGllcyBmaW5pc2hlcycsIGRvbmUgPT4ge1xuICAgICAgdmFyIHJlc29sdmU7XG4gICAgICBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJldHVybnMobmV3IFByb21pc2UoKF9yZXNvbHZlLCByZWplY3QpID0+IHJlc29sdmUgPSBfcmVzb2x2ZSkpO1xuICAgICAgdmFyIHN0cmVhbSA9IHN1cGVydmlzb3Iuc3RhcnQoY29uZmlnLCB0cmFuc2Zvcm0sIHMxLCBzMiwgczMpO1xuICAgICAgZXhwZWN0KHN1cGVydmlzb3IuX3J1blByb3hpZXMpLm5vdC50by5oYXZlLmJlZW4uY2FsbGVkO1xuICAgICAgczEucHVzaCgxKTtcblxuICAgICAgLy8gdGhpcyBzZXRUaW1lb3V0IHNpbXVsYXRlcyB0aGUgZmlyc3QgcmVhZGFibGUgZXZlbnRcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBleHBlY3Qoc3VwZXJ2aXNvci5fcnVuUHJveGllcykudG8uaGF2ZS5iZWVuLmNhbGxlZE9uY2U7XG5cbiAgICAgICAgLy8gQnkgcmVhZGluZyB0aGUgcXVldWUgZW1wdHksIHdlIGNyZWF0ZSB0aGUgY29uZGl0aW9ucyBmb3IgdGhlXG4gICAgICAgIC8vIHJlYWRhYmxlIGV2ZW50IHRvIGZpcmUgYWdhaW4uXG4gICAgICAgIHMxLnJlYWQoKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgICAgICAgIC8vIEFmdGVyIHdlIGhhdmUgcmVzb2x2ZWQgdGhlIHByb21pc2UsIHNpbXVsYXRpbmcgdGhlIGZpbmlzaCBvZiB0aGUgcHJveHlcbiAgICAgICAgICAvLyBhY3RvcnMsIHdlIHB1c2ggbW9yZSBkYXRhIG9udG8gdGhlIHF1ZXVlLCBzaW11bGF0aW5nIG5ldyBkYXRhLiBUaGlzXG4gICAgICAgICAgLy8gdHJpZ2dlcnMgYSBuZXcgcmVhZGFibGUgZXZldG4uXG4gICAgICAgICAgczEucHVzaCgyKTtcblxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KHN1cGVydmlzb3IuX3J1blByb3hpZXMuY2FsbENvdW50KS50by5lcXVhbCgyKTtcbiAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICB9KVxuXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cblxuICAgIGl0KCdyZXR1cm5zIGEgcmVhZGFibGUgc3RyZWFtJywgZG9uZSA9PiB7XG4gICAgICB2YXIgc3RyZWFtID0gc3VwZXJ2aXNvci5zdGFydChzMywgY29uZmlnKTtcblxuICAgICAgc3RyZWFtLm9uKCdyZWFkYWJsZScsICgpID0+IHtcbiAgICAgICAgZXhwZWN0KHN0cmVhbS5yZWFkKCkpLnRvLmVxdWFsKDEpO1xuICAgICAgICBleHBlY3Qoc3RyZWFtLnJlYWQoKSkudG8uZXF1YWwoMik7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuXG4gICAgICBzdHJlYW0ucHVzaCgxKTtcbiAgICAgIHN0cmVhbS5wdXNoKDIpO1xuICAgIH0pO1xuICB9KTtcblxufSk7XG4iXX0=