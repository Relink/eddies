'use strict';

var chai = require('chai');
chai.use(require('sinon-chai'));
var Promise = require('bluebird');
var expect = chai.expect;
var sinon = require('sinon');
var _ = require('lodash');
var stream = require('stream');
var EventEmitter = require('events').EventEmitter;
var proxyquire = require('proxyquire');

var actorMock = {
  start: sinon.stub()
};

var supervisor = proxyquire('./supervisor', {
  // './actor': actorMock
});

describe('supervisor', function () {
  var s1, s2, s3, s4, config, transform;

  beforeEach(function () {
    s1 = new stream.Readable({ objectMode: true, highwaterMark: 2 });
    s1._read = sinon.stub();

    s2 = new stream.Transform({ objectMode: true, highWaterMark: 2 });
    s2._transform = function (d, e, cb) {
      return cb(null, d);
    };

    s3 = new stream.Writable({ objectMode: true });
    s3._write = function () {
      return true;
    };

    s4 = new stream.Duplex({ objectMode: true, highWaterMark: 2,
      read: sinon.stub(), write: sinon.stub() });

    config = {};
    transform = sinon.stub();

    actorMock.start.reset();
  });

  describe('_trackErrors', function () {
    it('does not throw if successes come', function () {
      var ee = new EventEmitter();
      supervisor._trackErrors(2, ee);
      ee.emit('error');
      ee.emit('error');
      ee.emit('success');
      ee.emit('error');
    });

    it('throws if more errors than number given', function () {
      var ee = new EventEmitter();
      supervisor._trackErrors(1, ee);
      ee.emit('error');
      expect(ee.emit.bind(ee, 'error')).to.throw();
    });
  });

  describe('_startActors', function () {
    var errorCb, endCb, e1, errorEmitter;

    beforeEach(function () {
      errorCb = sinon.stub();
      endCb = sinon.stub();
      e1 = new EventEmitter();
      errorEmitter = new EventEmitter();
    });

    it('recycles, restarts, and reports an error', function (done) {
      var error = new Error('foo');
      error.originalInput = 'bar';
      actorMock.start.returns(e1);

      sinon.stub(s3, 'write', function () {
        return true;
      });

      errorEmitter.on('error', function (err) {
        expect(err).to.be.an('error');

        // give next tick so actor.start gets called again
        process.nextTick(function () {
          expect(s3.write).to.have.been.calledWith('bar');
          expect(actorMock.start).to.have.been.calledTwice;
          expect(actorMock.start.firstCall.args).to.deep.equal([s1, s2, transform]);
          done();
        });
      });

      supervisor._startActors(1, s1, s2, errorEmitter, transform, { rc: s3 }, endCb);
      e1.emit('error', error);
    });

    it('synchronously starts the number of actors it is asked to start', function () {
      actorMock.start.returns(e1);
      supervisor._startActors(4, s1, s2, errorEmitter, transform, config, endCb);
      expect(actorMock.start.callCount).to.equal(4);
    });

    it('handles errors even when no rc given', function (done) {
      actorMock.start.returns(e1);
      supervisor._startActors(1, s1, s2, errorEmitter, transform, config, endCb);
      errorEmitter.on('error', function (err) {
        expect(err).to.be.an.error;
        done();
      });
      e1.emit('error', new Error('foo'));
    });
  });

  describe('_runProxies', function () {
    var endCb;

    before(function () {
      var startActorMock = function startActorMock(num, src, dest, rc, ee, config, _endCb) {
        endCb = _endCb;
      };
      sinon.stub(supervisor, '_startActors', startActorMock);
    });

    after(function () {
      return supervisor._startActors.restore();
    });

    it('does not resolve until endCb called enough times', function (done) {
      var resolved = false;

      supervisor._runProxies(s1, s2, s4, transform, { number: 2, errorCount: 1 }).then(function (res) {
        resolved = true;
      });

      endCb();
      setTimeout(function () {
        expect(resolved).to.be.false;
        done();
      });
    });

    it('resolves when the endCb is called and it has called startActors', function (done) {
      var resolved = false;
      supervisor._runProxies(s1, s2, s4, transform, { number: 3, errorCount: 1 }).then(function (res) {
        resolved = true;
        expect(supervisor._startActors).to.have.been.calledWith(3);
        done();
      });
      endCb();
      endCb();
      endCb();
      expect(resolved).to.be.false;
    });
  });

  describe('start', function () {

    before(function () {
      return sinon.stub(supervisor, '_runProxies');
    });
    beforeEach(function () {
      return supervisor._runProxies.reset();
    });
    after(function () {
      return supervisor._runProxies.restore();
    });

    it('propogates errors to returned stream', function (done) {
      supervisor._runProxies.returns(Promise.reject(new Error('foo')));
      supervisor.start(config, transform, s1, s2, s3).on('error', function (err) {
        expect(err).to.be.an.error;
        done();
      });
      s1.push(1);
    });

    it('removes the listener so that it doesnt call runProxies more than once', function (done) {
      supervisor._runProxies.returns(new Promise(function (resolve, reject) {
        return true;
      }));
      supervisor.start(config, transform, s1, s2, s3);
      s1.push(1);
      s1.push(2);
      process.nextTick(function () {
        s1.push(3);
        process.nextTick(function () {
          expect(supervisor._runProxies).to.have.been.calledOnce;
          done();
        });
      });
    });

    it('adds a listener to restart after runProxies finishes', function (done) {
      var resolve;
      supervisor._runProxies.returns(new Promise(function (_resolve, reject) {
        return resolve = _resolve;
      }));
      var stream = supervisor.start(config, transform, s1, s2, s3);
      expect(supervisor._runProxies).not.to.have.been.called;
      s1.push(1);

      // this setTimeout simulates the first readable event
      setTimeout(function () {
        expect(supervisor._runProxies).to.have.been.calledOnce;

        // By reading the queue empty, we create the conditions for the
        // readable event to fire again.
        s1.read();
        resolve();
        setTimeout(function () {

          // After we have resolved the promise, simulating the finish of the proxy
          // actors, we push more data onto the queue, simulating new data. This
          // triggers a new readable evetn.
          s1.push(2);

          setTimeout(function () {
            expect(supervisor._runProxies.callCount).to.equal(2);
            done();
          });
        });
      });
    });

    it('returns a readable stream', function (done) {
      var stream = supervisor.start(s3, config);

      stream.on('readable', function () {
        expect(stream.read()).to.equal(1);
        expect(stream.read()).to.equal(2);
        done();
      });

      stream.push(1);
      stream.push(2);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXBlcnZpc29yLnNwZWMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJLE9BQU8sUUFBUSxNQUFSLENBQVA7QUFDSixLQUFLLEdBQUwsQ0FBUyxRQUFRLFlBQVIsQ0FBVDtBQUNBLElBQUksVUFBVSxRQUFRLFVBQVIsQ0FBVjtBQUNKLElBQUksU0FBUyxLQUFLLE1BQUw7QUFDYixJQUFJLFFBQVEsUUFBUSxPQUFSLENBQVI7QUFDSixJQUFJLElBQUksUUFBUSxRQUFSLENBQUo7QUFDSixJQUFJLFNBQVMsUUFBUSxRQUFSLENBQVQ7QUFDSixJQUFJLGVBQWUsUUFBUSxRQUFSLEVBQWtCLFlBQWxCO0FBQ25CLElBQUksYUFBYSxRQUFRLFlBQVIsQ0FBYjs7QUFFSixJQUFJLFlBQVk7QUFDZCxTQUFPLE1BQU0sSUFBTixFQUFQO0NBREU7O0FBSUosSUFBSSxhQUFhLFdBQVcsY0FBWCxFQUEyQjs7Q0FBM0IsQ0FBYjs7QUFJSixTQUFTLFlBQVQsRUFBdUIsWUFBTTtBQUMzQixNQUFJLEVBQUosRUFBUSxFQUFSLEVBQVksRUFBWixFQUFnQixFQUFoQixFQUFvQixNQUFwQixFQUE0QixTQUE1QixDQUQyQjs7QUFHM0IsYUFBVyxZQUFNO0FBQ2YsU0FBSyxJQUFJLE9BQU8sUUFBUCxDQUFnQixFQUFFLFlBQVksSUFBWixFQUFrQixlQUFlLENBQWYsRUFBeEMsQ0FBTCxDQURlO0FBRWYsT0FBRyxLQUFILEdBQVcsTUFBTSxJQUFOLEVBQVgsQ0FGZTs7QUFJZixTQUFLLElBQUksT0FBTyxTQUFQLENBQWlCLEVBQUUsWUFBWSxJQUFaLEVBQWtCLGVBQWUsQ0FBZixFQUF6QyxDQUFMLENBSmU7QUFLZixPQUFHLFVBQUgsR0FBZ0IsVUFBQyxDQUFELEVBQUksQ0FBSixFQUFPLEVBQVA7YUFBYyxHQUFHLElBQUgsRUFBUyxDQUFUO0tBQWQsQ0FMRDs7QUFPZixTQUFLLElBQUksT0FBTyxRQUFQLENBQWdCLEVBQUUsWUFBWSxJQUFaLEVB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RyxJQUFILEdBTGU7QUFNZixrQkFOZTtBQU9mLG1CQUFXLFlBQU07Ozs7O0FBS2YsYUFBRyxJQUFILENBQVEsQ0FBUixFQUxlOztBQU9mLHFCQUFXLFlBQU07QUFDZixtQkFBTyxXQUFXLFdBQVgsQ0FBdUIsU0FBdkIsQ0FBUCxDQUF5QyxFQUF6QyxDQUE0QyxLQUE1QyxDQUFrRCxDQUFsRCxFQURlO0FBRWYsbUJBRmU7V0FBTixDQUFYLENBUGU7U0FBTixDQUFYLENBUGU7T0FBTixDQUFYLENBUmlFO0tBQVIsQ0FBM0QsQ0E5QnNCOztBQThEdEIsT0FBRywyQkFBSCxFQUFnQyxnQkFBUTtBQUN0QyxVQUFJLFNBQVMsV0FBVyxLQUFYLENBQWlCLEVBQWpCLEVBQXFCLE1BQXJCLENBQVQsQ0FEa0M7O0FBR3RDLGFBQU8sRUFBUCxDQUFVLFVBQVYsRUFBc0IsWUFBTTtBQUMxQixlQUFPLE9BQU8sSUFBUCxFQUFQLEVBQXNCLEVBQXRCLENBQXlCLEtBQXpCLENBQStCLENBQS9CLEVBRDBCO0FBRTFCLGVBQU8sT0FBTyxJQUFQLEVBQVAsRUFBc0IsRUFBdEIsQ0FBeUIsS0FBekIsQ0FBK0IsQ0FBL0IsRUFGMEI7QUFHMUIsZUFIMEI7T0FBTixDQUF0QixDQUhzQzs7QUFTdEMsYUFBTyxJQUFQLENBQVksQ0FBWixFQVRzQztBQVV0QyxhQUFPLElBQVAsQ0FBWSxDQUFaLEVBVnNDO0tBQVIsQ0FBaEMsQ0E5RHNCO0dBQU4sQ0FBbEIsQ0F0STJCO0NBQU4sQ0FBdkIiLCJmaWxlIjoic3VwZXJ2aXNvci5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGNoYWkgPSByZXF1aXJlKCdjaGFpJyk7XG5jaGFpLnVzZShyZXF1aXJlKCdzaW5vbi1jaGFpJykpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xudmFyIGV4cGVjdCA9IGNoYWkuZXhwZWN0O1xudmFyIHNpbm9uID0gcmVxdWlyZSgnc2lub24nKTtcbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgc3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7XG52YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyO1xudmFyIHByb3h5cXVpcmUgPSByZXF1aXJlKCdwcm94eXF1aXJlJyk7XG5cbnZhciBhY3Rvck1vY2sgPSB7XG4gIHN0YXJ0OiBzaW5vbi5zdHViKClcbn07XG5cbnZhciBzdXBlcnZpc29yID0gcHJveHlxdWlyZSgnLi9zdXBlcnZpc29yJywge1xuICAvLyAnLi9hY3Rvcic6IGFjdG9yTW9ja1xufSk7XG5cbmRlc2NyaWJlKCdzdXBlcnZpc29yJywgKCkgPT4ge1xuICB2YXIgczEsIHMyLCBzMywgczQsIGNvbmZpZywgdHJhbnNmb3JtO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHMxID0gbmV3IHN0cmVhbS5SZWFkYWJsZSh7IG9iamVjdE1vZGU6IHRydWUsIGhpZ2h3YXRlck1hcms6IDIgfSk7XG4gICAgczEuX3JlYWQgPSBzaW5vbi5zdHViKCk7XG5cbiAgICBzMiA9IG5ldyBzdHJlYW0uVHJhbnNmb3JtKHsgb2JqZWN0TW9kZTogdHJ1ZSwgaGlnaFdhdGVyTWFyazogMn0pO1xuICAgIHMyLl90cmFuc2Zvcm0gPSAoZCwgZSwgY2IpID0+IGNiKG51bGwsIGQpO1xuXG4gICAgczMgPSBuZXcgc3RyZWFtLldyaXRhYmxlKHsgb2JqZWN0TW9kZTogdHJ1ZSB9KTtcbiAgICBzMy5fd3JpdGUgPSAoKSA9PiB7IHJldHVybiB0cnVlIH07XG5cbiAgICBzNCA9IG5ldyBzdHJlYW0uRHVwbGV4KHsgb2JqZWN0TW9kZTogdHJ1ZSwgaGlnaFdhdGVyTWFyazogMixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZDogc2lub24uc3R1YigpLCB3cml0ZTogc2lub24uc3R1YigpfSlcblxuICAgIGNvbmZpZyA9IHt9O1xuICAgIHRyYW5zZm9ybSA9IHNpbm9uLnN0dWIoKTtcblxuICAgIGFjdG9yTW9jay5zdGFydC5yZXNldCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnX3RyYWNrRXJyb3JzJywgKCkgPT4ge1xuICAgIGl0KCdkb2VzIG5vdCB0aHJvdyBpZiBzdWNjZXNzZXMgY29tZScsICgpID0+IHtcbiAgICAgIHZhciBlZSA9IG5ldyBFdmVudEVtaXR0ZXIoKVxuICAgICAgc3VwZXJ2aXNvci5fdHJhY2tFcnJvcnMoMiwgZWUpXG4gICAgICBlZS5lbWl0KCdlcnJvcicpO1xuICAgICAgZWUuZW1pdCgnZXJyb3InKTtcbiAgICAgIGVlLmVtaXQoJ3N1Y2Nlc3MnKTtcbiAgICAgIGVlLmVtaXQoJ2Vycm9yJyk7XG4gICAgfSk7XG5cbiAgICBpdCgndGhyb3dzIGlmIG1vcmUgZXJyb3JzIHRoYW4gbnVtYmVyIGdpdmVuJywgKCkgPT4ge1xuICAgICAgdmFyIGVlID0gbmV3IEV2ZW50RW1pdHRlcigpXG4gICAgICBzdXBlcnZpc29yLl90cmFja0Vycm9ycygxLCBlZSlcbiAgICAgIGVlLmVtaXQoJ2Vycm9yJyk7XG4gICAgICBleHBlY3QoZWUuZW1pdC5iaW5kKGVlLCAnZXJyb3InKSkudG8udGhyb3coKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ19zdGFydEFjdG9ycycsICgpID0+IHtcbiAgICB2YXIgZXJyb3JDYiwgZW5kQ2IsIGUxLCBlcnJvckVtaXR0ZXI7XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGVycm9yQ2IgPSBzaW5vbi5zdHViKCk7XG4gICAgICBlbmRDYiA9IHNpbm9uLnN0dWIoKTtcbiAgICAgIGUxID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgZXJyb3JFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3JlY3ljbGVzLCByZXN0YXJ0cywgYW5kIHJlcG9ydHMgYW4gZXJyb3InLCBkb25lID0+IHtcbiAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignZm9vJyk7XG4gICAgICBlcnJvci5vcmlnaW5hbElucHV0ID0gJ2Jhcic7XG4gICAgICBhY3Rvck1vY2suc3RhcnQucmV0dXJucyhlMSk7XG5cbiAgICAgIHNpbm9uLnN0dWIoczMsICd3cml0ZScsICgpID0+IHRydWUpO1xuXG4gICAgICBlcnJvckVtaXR0ZXIub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgZXhwZWN0KGVycikudG8uYmUuYW4oJ2Vycm9yJyk7XG5cbiAgICAgICAgLy8gZ2l2ZSBuZXh0IHRpY2sgc28gYWN0b3Iuc3RhcnQgZ2V0cyBjYWxsZWQgYWdhaW5cbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHMzLndyaXRlKS50by5oYXZlLmJlZW4uY2FsbGVkV2l0aCgnYmFyJyk7XG4gICAgICAgICAgZXhwZWN0KGFjdG9yTW9jay5zdGFydCkudG8uaGF2ZS5iZWVuLmNhbGxlZFR3aWNlO1xuICAgICAgICAgIGV4cGVjdChhY3Rvck1vY2suc3RhcnQuZmlyc3RDYWxsLmFyZ3MpXG4gICAgICAgICAgICAudG8uZGVlcC5lcXVhbChbczEsIHMyLCB0cmFuc2Zvcm1dKVxuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMoMSwgczEsIHMyLCBlcnJvckVtaXR0ZXIsIHRyYW5zZm9ybSwge3JjOiBzM30sIGVuZENiKTtcbiAgICAgIGUxLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3N5bmNocm9ub3VzbHkgc3RhcnRzIHRoZSBudW1iZXIgb2YgYWN0b3JzIGl0IGlzIGFza2VkIHRvIHN0YXJ0JywgKCkgPT4ge1xuICAgICAgYWN0b3JNb2NrLnN0YXJ0LnJldHVybnMoZTEpO1xuICAgICAgc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMoNCwgczEsIHMyLCBlcnJvckVtaXR0ZXIsIHRyYW5zZm9ybSwgY29uZmlnLCBlbmRDYik7XG4gICAgICBleHBlY3QoYWN0b3JNb2NrLnN0YXJ0LmNhbGxDb3VudCkudG8uZXF1YWwoNCk7XG4gICAgfSk7XG5cbiAgICBpdCgnaGFuZGxlcyBlcnJvcnMgZXZlbiB3aGVuIG5vIHJjIGdpdmVuJywgZG9uZSA9PiB7XG4gICAgICBhY3Rvck1vY2suc3RhcnQucmV0dXJucyhlMSk7XG4gICAgICBzdXBlcnZpc29yLl9zdGFydEFjdG9ycygxLCBzMSwgczIsIGVycm9yRW1pdHRlciwgdHJhbnNmb3JtLCBjb25maWcsIGVuZENiKTtcbiAgICAgIGVycm9yRW1pdHRlci5vbignZXJyb3InLCBlcnIgPT4ge1xuICAgICAgICBleHBlY3QoZXJyKS50by5iZS5hbi5lcnJvcjtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgICBlMS5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignZm9vJykpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnX3J1blByb3hpZXMnLCAoKSA9PiB7XG4gICAgdmFyIGVuZENiO1xuXG4gICAgYmVmb3JlKCgpID0+IHtcbiAgICAgIHZhciBzdGFydEFjdG9yTW9jayA9IGZ1bmN0aW9uIChudW0sIHNyYywgZGVzdCwgcmMsIGVlLCBjb25maWcsIF9lbmRDYil7XG4gICAgICAgIGVuZENiID0gX2VuZENiO1xuICAgICAgfVxuICAgICAgc2lub24uc3R1YihzdXBlcnZpc29yLCAnX3N0YXJ0QWN0b3JzJywgc3RhcnRBY3Rvck1vY2spO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXIoKCkgPT4gc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMucmVzdG9yZSgpKVxuXG4gICAgaXQoJ2RvZXMgbm90IHJlc29sdmUgdW50aWwgZW5kQ2IgY2FsbGVkIGVub3VnaCB0aW1lcycsIGRvbmUgPT4ge1xuICAgICAgdmFyIHJlc29sdmVkID0gZmFsc2U7XG5cbiAgICAgIHN1cGVydmlzb3IuX3J1blByb3hpZXMoczEsIHMyLCBzNCwgdHJhbnNmb3JtLCB7bnVtYmVyOiAyLCBlcnJvckNvdW50OiAxfSlcbiAgICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICByZXNvbHZlZCA9IHRydWU7XG4gICAgICAgIH0pO1xuXG4gICAgICBlbmRDYigpO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXNvbHZlZCkudG8uYmUuZmFsc2U7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Jlc29sdmVzIHdoZW4gdGhlIGVuZENiIGlzIGNhbGxlZCBhbmQgaXQgaGFzIGNhbGxlZCBzdGFydEFjdG9ycycsIGRvbmUgID0+IHtcbiAgICAgIHZhciByZXNvbHZlZCA9IGZhbHNlO1xuICAgICAgc3VwZXJ2aXNvci5fcnVuUHJveGllcyhzMSwgczIsIHM0LCB0cmFuc2Zvcm0sIHtudW1iZXI6IDMsIGVycm9yQ291bnQ6IDF9KVxuICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTtcbiAgICAgICAgICBleHBlY3Qoc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMpLnRvLmhhdmUuYmVlbi5jYWxsZWRXaXRoKDMpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSlcbiAgICAgIGVuZENiKCk7XG4gICAgICBlbmRDYigpO1xuICAgICAgZW5kQ2IoKTtcbiAgICAgIGV4cGVjdChyZXNvbHZlZCkudG8uYmUuZmFsc2U7XG4gICAgfSk7XG4gIH0pO1xuXG5cbiAgZGVzY3JpYmUoJ3N0YXJ0JywgKCkgPT4ge1xuXG4gICAgYmVmb3JlKCgpID0+IHNpbm9uLnN0dWIoc3VwZXJ2aXNvciwgJ19ydW5Qcm94aWVzJykpO1xuICAgIGJlZm9yZUVhY2goKCkgPT4gc3VwZXJ2aXNvci5fcnVuUHJveGllcy5yZXNldCgpKTtcbiAgICBhZnRlcigoKSA9PiBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJlc3RvcmUoKSk7XG5cbiAgICBpdCgncHJvcG9nYXRlcyBlcnJvcnMgdG8gcmV0dXJuZWQgc3RyZWFtJywgZG9uZSA9PiB7XG4gICAgICBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJldHVybnMoUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdmb28nKSkpO1xuICAgICAgc3VwZXJ2aXNvci5zdGFydChjb25maWcsIHRyYW5zZm9ybSwgczEsIHMyLCBzMylcbiAgICAgICAgLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICAgICAgZXhwZWN0KGVycikudG8uYmUuYW4uZXJyb3I7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIHMxLnB1c2goMSlcbiAgICB9KTtcblxuICAgIGl0KCdyZW1vdmVzIHRoZSBsaXN0ZW5lciBzbyB0aGF0IGl0IGRvZXNudCBjYWxsIHJ1blByb3hpZXMgbW9yZSB0aGFuIG9uY2UnLCBkb25lID0+IHtcbiAgICAgIHN1cGVydmlzb3IuX3J1blByb3hpZXMucmV0dXJucyhuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0cnVlKSk7XG4gICAgICBzdXBlcnZpc29yLnN0YXJ0KGNvbmZpZywgdHJhbnNmb3JtLCBzMSwgczIsIHMzKTtcbiAgICAgIHMxLnB1c2goMSk7XG4gICAgICBzMS5wdXNoKDIpO1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIHMxLnB1c2goMyk7XG4gICAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICAgIGV4cGVjdChzdXBlcnZpc29yLl9ydW5Qcm94aWVzKS50by5oYXZlLmJlZW4uY2FsbGVkT25jZTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnYWRkcyBhIGxpc3RlbmVyIHRvIHJlc3RhcnQgYWZ0ZXIgcnVuUHJveGllcyBmaW5pc2hlcycsIGRvbmUgPT4ge1xuICAgICAgdmFyIHJlc29sdmU7XG4gICAgICBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJldHVybnMobmV3IFByb21pc2UoKF9yZXNvbHZlLCByZWplY3QpID0+IHJlc29sdmUgPSBfcmVzb2x2ZSkpO1xuICAgICAgdmFyIHN0cmVhbSA9IHN1cGVydmlzb3Iuc3RhcnQoY29uZmlnLCB0cmFuc2Zvcm0sIHMxLCBzMiwgczMpO1xuICAgICAgZXhwZWN0KHN1cGVydmlzb3IuX3J1blByb3hpZXMpLm5vdC50by5oYXZlLmJlZW4uY2FsbGVkO1xuICAgICAgczEucHVzaCgxKTtcblxuICAgICAgLy8gdGhpcyBzZXRUaW1lb3V0IHNpbXVsYXRlcyB0aGUgZmlyc3QgcmVhZGFibGUgZXZlbnRcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBleHBlY3Qoc3VwZXJ2aXNvci5fcnVuUHJveGllcykudG8uaGF2ZS5iZWVuLmNhbGxlZE9uY2U7XG5cbiAgICAgICAgLy8gQnkgcmVhZGluZyB0aGUgcXVldWUgZW1wdHksIHdlIGNyZWF0ZSB0aGUgY29uZGl0aW9ucyBmb3IgdGhlXG4gICAgICAgIC8vIHJlYWRhYmxlIGV2ZW50IHRvIGZpcmUgYWdhaW4uXG4gICAgICAgIHMxLnJlYWQoKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgICAgICAgIC8vIEFmdGVyIHdlIGhhdmUgcmVzb2x2ZWQgdGhlIHByb21pc2UsIHNpbXVsYXRpbmcgdGhlIGZpbmlzaCBvZiB0aGUgcHJveHlcbiAgICAgICAgICAvLyBhY3RvcnMsIHdlIHB1c2ggbW9yZSBkYXRhIG9udG8gdGhlIHF1ZXVlLCBzaW11bGF0aW5nIG5ldyBkYXRhLiBUaGlzXG4gICAgICAgICAgLy8gdHJpZ2dlcnMgYSBuZXcgcmVhZGFibGUgZXZldG4uXG4gICAgICAgICAgczEucHVzaCgyKTtcblxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KHN1cGVydmlzb3IuX3J1blByb3hpZXMuY2FsbENvdW50KS50by5lcXVhbCgyKTtcbiAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICB9KVxuXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cblxuICAgIGl0KCdyZXR1cm5zIGEgcmVhZGFibGUgc3RyZWFtJywgZG9uZSA9PiB7XG4gICAgICB2YXIgc3RyZWFtID0gc3VwZXJ2aXNvci5zdGFydChzMywgY29uZmlnKTtcblxuICAgICAgc3RyZWFtLm9uKCdyZWFkYWJsZScsICgpID0+IHtcbiAgICAgICAgZXhwZWN0KHN0cmVhbS5yZWFkKCkpLnRvLmVxdWFsKDEpO1xuICAgICAgICBleHBlY3Qoc3RyZWFtLnJlYWQoKSkudG8uZXF1YWwoMik7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuXG4gICAgICBzdHJlYW0ucHVzaCgxKTtcbiAgICAgIHN0cmVhbS5wdXNoKDIpO1xuICAgIH0pO1xuICB9KTtcblxufSk7XG4iXX0=