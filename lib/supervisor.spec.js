'use strict';

var chai = require('chai');
chai.use(require('sinon-chai'));
var Promise = require('bluebird');
var expect = chai.expect;
var sinon = require('sinon');
var _ = require('lodash');
var stream = require('stream');
var EventEmitter = require('events').EventEmitter;
var proxyquire = require('proxyquire');

var actorMock = {
  start: sinon.stub()
};

var supervisor = proxyquire('./supervisor', {
  './actor': actorMock
});

describe('supervisor', function () {
  var s1, s2, s3, s4, config, transform;

  beforeEach(function () {
    s1 = new stream.Readable({ objectMode: true, highwaterMark: 2 });
    s1._read = sinon.stub();

    s2 = new stream.Transform({ objectMode: true, highWaterMark: 2 });
    s2._transform = function (d, e, cb) {
      return cb(null, d);
    };

    s3 = new stream.Writable({ objectMode: true });
    s3._write = function () {
      return true;
    };

    s4 = new stream.Duplex({ objectMode: true, highWaterMark: 2,
      read: sinon.stub(), write: sinon.stub() });

    config = {};
    transform = sinon.stub();

    actorMock.start.reset();
  });

  describe('_trackErrors', function () {
    it('does not throw if successes come', function () {
      var ee = new EventEmitter();
      supervisor._trackErrors(2, ee);
      ee.emit('eddies:warn');
      ee.emit('eddies:warn');
      ee.emit('eddies:success');
      ee.emit('eddies:warn');
    });

    it('throws if more errors than number given', function () {
      var ee = new EventEmitter();
      supervisor._trackErrors(1, ee);
      ee.emit('eddies:warn');
      expect(ee.emit.bind(ee, 'eddies:warn')).to.throw();
    });
  });

  describe('_startActors', function () {
    var errorCb, endCb, e1, errorEmitter;

    beforeEach(function () {
      errorCb = sinon.stub();
      endCb = sinon.stub();
      e1 = new EventEmitter();
      errorEmitter = new EventEmitter();
    });

    it('recycles, restarts, and reports an error', function (done) {
      var error = new Error('foo');
      error.originalInput = 'bar';
      actorMock.start.returns(e1);

      sinon.stub(s3, 'write', function () {
        return true;
      });

      errorEmitter.on('eddies:warn', function (err) {
        expect(err).to.be.an('error');

        // give next tick so actor.start gets called again
        process.nextTick(function () {
          expect(s3.write).to.have.been.calledWith('bar');
          expect(actorMock.start).to.have.been.calledTwice;
          expect(actorMock.start.firstCall.args).to.deep.equal([s1, s2, transform]);
          done();
        });
      });

      supervisor._startActors(1, s1, s2, errorEmitter, transform, { rc: s3 }, endCb);
      e1.emit('error', error);
    });

    it('asynchronously starts the number of actors it is asked to start', function (done) {
      actorMock.start.returns(e1);
      supervisor._startActors(4, s1, s2, errorEmitter, transform, config, endCb);
      setTimeout(function () {
        expect(actorMock.start.callCount).to.equal(4);
        done();
      }, 20);
    });

    it('handles errors even when no rc given', function (done) {
      actorMock.start.returns(e1);
      supervisor._startActors(1, s1, s2, errorEmitter, transform, config, endCb);
      errorEmitter.on('eddies:warn', function (err) {
        expect(err).to.be.an.error;
        done();
      });
      e1.emit('error', new Error('foo'));
    });
  });

  describe('_runProxies', function () {
    var endCb;

    before(function () {
      var startActorMock = function startActorMock(num, src, dest, rc, ee, config, _endCb) {
        endCb = _endCb;
      };
      sinon.stub(supervisor, '_startActors', startActorMock);
    });

    after(function () {
      return supervisor._startActors.restore();
    });

    it('does not resolve until endCb called enough times', function (done) {
      var resolved = false;

      supervisor._runProxies(s1, s2, s4, transform, { number: 2, errorCount: 1 }).then(function (res) {
        resolved = true;
      });

      endCb();
      setTimeout(function () {
        expect(resolved).to.be.false;
        done();
      });
    });

    it('resolves when the endCb is called and it has called startActors', function (done) {
      var resolved = false;
      supervisor._runProxies(s1, s2, s4, transform, { number: 3, errorCount: 1 }).then(function (res) {
        resolved = true;
        expect(supervisor._startActors).to.have.been.calledWith(3);
        done();
      });
      endCb();
      endCb();
      endCb();
      expect(resolved).to.be.false;
    });
  });

  describe('start', function () {

    before(function () {
      return sinon.stub(supervisor, '_runProxies');
    });
    beforeEach(function () {
      return supervisor._runProxies.reset();
    });
    after(function () {
      return supervisor._runProxies.restore();
    });

    it('propogates errors to returned stream', function (done) {
      supervisor._runProxies.returns(Promise.reject(new Error('foo')));
      supervisor.start(config, transform, s1, s2, s3).on('error', function (err) {
        expect(err).to.be.an.error;
        done();
      });
      s1.push(1);
    });

    it('removes the listener so that it doesnt call runProxies more than once', function (done) {
      supervisor._runProxies.returns(new Promise(function (resolve, reject) {
        return true;
      }));
      supervisor.start(config, transform, s1, s2, s3);
      s1.push(1);
      s1.push(2);
      process.nextTick(function () {
        s1.push(3);
        process.nextTick(function () {
          expect(supervisor._runProxies).to.have.been.calledOnce;
          done();
        });
      });
    });

    it('adds a listener to restart after runProxies finishes', function (done) {
      var resolve;
      supervisor._runProxies.returns(new Promise(function (_resolve, reject) {
        return resolve = _resolve;
      }));
      var stream = supervisor.start(config, transform, s1, s2, s3);
      expect(supervisor._runProxies).not.to.have.been.called;
      s1.push(1);

      // this setTimeout simulates the first readable event
      setTimeout(function () {
        expect(supervisor._runProxies).to.have.been.calledOnce;

        // By reading the queue empty, we create the conditions for the
        // readable event to fire again.
        s1.read();
        resolve();
        setTimeout(function () {

          // After we have resolved the promise, simulating the finish of the proxy
          // actors, we push more data onto the queue, simulating new data. This
          // triggers a new readable evetn.
          s1.push(2);

          setTimeout(function () {
            expect(supervisor._runProxies.callCount).to.equal(2);
            done();
          });
        });
      });
    });

    it('returns a readable stream', function (done) {
      var stream = supervisor.start(s3, config);

      stream.on('readable', function () {
        expect(stream.read()).to.equal(1);
        expect(stream.read()).to.equal(2);
        done();
      });

      stream.push(1);
      stream.push(2);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXBlcnZpc29yLnNwZWMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJLE9BQU8sUUFBUSxNQUFSLENBQVA7QUFDSixLQUFLLEdBQUwsQ0FBUyxRQUFRLFlBQVIsQ0FBVDtBQUNBLElBQUksVUFBVSxRQUFRLFVBQVIsQ0FBVjtBQUNKLElBQUksU0FBUyxLQUFLLE1BQUw7QUFDYixJQUFJLFFBQVEsUUFBUSxPQUFSLENBQVI7QUFDSixJQUFJLElBQUksUUFBUSxRQUFSLENBQUo7QUFDSixJQUFJLFNBQVMsUUFBUSxRQUFSLENBQVQ7QUFDSixJQUFJLGVBQWUsUUFBUSxRQUFSLEVBQWtCLFlBQWxCO0FBQ25CLElBQUksYUFBYSxRQUFRLFlBQVIsQ0FBYjs7QUFFSixJQUFJLFlBQVk7QUFDZCxTQUFPLE1BQU0sSUFBTixFQUFQO0NBREU7O0FBSUosSUFBSSxhQUFhLFdBQVcsY0FBWCxFQUEyQjtBQUMxQyxhQUFXLFNBQVg7Q0FEZSxDQUFiOztBQUlKLFNBQVMsWUFBVCxFQUF1QixZQUFNO0FBQzNCLE1BQUksRUFBSixFQUFRLEVBQVIsRUFBWSxFQUFaLEVBQWdCLEVBQWhCLEVBQW9CLE1BQXBCLEVBQTRCLFNBQTVCLENBRDJCOztBQUczQixhQUFXLFlBQU07QUFDZixTQUFLLElBQUksT0FBTyxRQUFQLENBQWdCLEVBQUUsWUFBWSxJQUFaLEVBQWtCLGVBQWUsQ0FBZixFQUF4QyxDQUFMLENBRGU7QUFFZixPQUFHLEtBQUgsR0FBVyxNQUFNLElBQU4sRUFBWCxDQUZlOztBQUlmLFNBQUssSUFBSSxPQUFPLFNBQVAsQ0FBaUIsRUFBRSxZQUFZLElBQVosRUFBa0IsZUFBZSxDQUFmLEVBQXpDLENBQUwsQ0FKZTtBQUtmLE9BQUcsVUFBSCxHQUFnQixVQUFDLENBQUQsRUFBSSxDQUFKLEVBQU8sRUFBUDthQUFjLEdBQUcsSUFBSCxFQUFTLENBQVQ7S0FBZCxDQUxEOztBQU9mLFNBQUssSUFBSSxPQUFPLFFBQVAsQ0FBZ0IsRUFB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QStCLEVBQS9CLENBQWtDLElBQWxDLENBQXVDLElBQXZDLENBQTRDLFVBQTVDOzs7O0FBRGUsVUFLZixDQUFHLElBQUgsR0FMZTtBQU1mLGtCQU5lO0FBT2YsbUJBQVcsWUFBTTs7Ozs7QUFLZixhQUFHLElBQUgsQ0FBUSxDQUFSLEVBTGU7O0FBT2YscUJBQVcsWUFBTTtBQUNmLG1CQUFPLFdBQVcsV0FBWCxDQUF1QixTQUF2QixDQUFQLENBQXlDLEVBQXpDLENBQTRDLEtBQTVDLENBQWtELENBQWxELEVBRGU7QUFFZixtQkFGZTtXQUFOLENBQVgsQ0FQZTtTQUFOLENBQVgsQ0FQZTtPQUFOLENBQVgsQ0FSaUU7S0FBUixDQUEzRCxDQTlCc0I7O0FBNkR0QixPQUFHLDJCQUFILEVBQWdDLGdCQUFRO0FBQ3RDLFVBQUksU0FBUyxXQUFXLEtBQVgsQ0FBaUIsRUFBakIsRUFBcUIsTUFBckIsQ0FBVCxDQURrQzs7QUFHdEMsYUFBTyxFQUFQLENBQVUsVUFBVixFQUFzQixZQUFNO0FBQzFCLGVBQU8sT0FBTyxJQUFQLEVBQVAsRUFBc0IsRUFBdEIsQ0FBeUIsS0FBekIsQ0FBK0IsQ0FBL0IsRUFEMEI7QUFFMUIsZUFBTyxPQUFPLElBQVAsRUFBUCxFQUFzQixFQUF0QixDQUF5QixLQUF6QixDQUErQixDQUEvQixFQUYwQjtBQUcxQixlQUgwQjtPQUFOLENBQXRCLENBSHNDOztBQVN0QyxhQUFPLElBQVAsQ0FBWSxDQUFaLEVBVHNDO0FBVXRDLGFBQU8sSUFBUCxDQUFZLENBQVosRUFWc0M7S0FBUixDQUFoQyxDQTdEc0I7R0FBTixDQUFsQixDQXpJMkI7Q0FBTixDQUF2QiIsImZpbGUiOiJzdXBlcnZpc29yLnNwZWMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgY2hhaSA9IHJlcXVpcmUoJ2NoYWknKTtcbmNoYWkudXNlKHJlcXVpcmUoJ3Npbm9uLWNoYWknKSk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG52YXIgZXhwZWN0ID0gY2hhaS5leHBlY3Q7XG52YXIgc2lub24gPSByZXF1aXJlKCdzaW5vbicpO1xudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG52YXIgcHJveHlxdWlyZSA9IHJlcXVpcmUoJ3Byb3h5cXVpcmUnKTtcblxudmFyIGFjdG9yTW9jayA9IHtcbiAgc3RhcnQ6IHNpbm9uLnN0dWIoKVxufTtcblxudmFyIHN1cGVydmlzb3IgPSBwcm94eXF1aXJlKCcuL3N1cGVydmlzb3InLCB7XG4gICcuL2FjdG9yJzogYWN0b3JNb2NrXG59KTtcblxuZGVzY3JpYmUoJ3N1cGVydmlzb3InLCAoKSA9PiB7XG4gIHZhciBzMSwgczIsIHMzLCBzNCwgY29uZmlnLCB0cmFuc2Zvcm07XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgczEgPSBuZXcgc3RyZWFtLlJlYWRhYmxlKHsgb2JqZWN0TW9kZTogdHJ1ZSwgaGlnaHdhdGVyTWFyazogMiB9KTtcbiAgICBzMS5fcmVhZCA9IHNpbm9uLnN0dWIoKTtcblxuICAgIHMyID0gbmV3IHN0cmVhbS5UcmFuc2Zvcm0oeyBvYmplY3RNb2RlOiB0cnVlLCBoaWdoV2F0ZXJNYXJrOiAyfSk7XG4gICAgczIuX3RyYW5zZm9ybSA9IChkLCBlLCBjYikgPT4gY2IobnVsbCwgZCk7XG5cbiAgICBzMyA9IG5ldyBzdHJlYW0uV3JpdGFibGUoeyBvYmplY3RNb2RlOiB0cnVlIH0pO1xuICAgIHMzLl93cml0ZSA9ICgpID0+IHsgcmV0dXJuIHRydWUgfTtcblxuICAgIHM0ID0gbmV3IHN0cmVhbS5EdXBsZXgoeyBvYmplY3RNb2RlOiB0cnVlLCBoaWdoV2F0ZXJNYXJrOiAyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkOiBzaW5vbi5zdHViKCksIHdyaXRlOiBzaW5vbi5zdHViKCl9KVxuXG4gICAgY29uZmlnID0ge307XG4gICAgdHJhbnNmb3JtID0gc2lub24uc3R1YigpO1xuXG4gICAgYWN0b3JNb2NrLnN0YXJ0LnJlc2V0KCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdfdHJhY2tFcnJvcnMnLCAoKSA9PiB7XG4gICAgaXQoJ2RvZXMgbm90IHRocm93IGlmIHN1Y2Nlc3NlcyBjb21lJywgKCkgPT4ge1xuICAgICAgdmFyIGVlID0gbmV3IEV2ZW50RW1pdHRlcigpXG4gICAgICBzdXBlcnZpc29yLl90cmFja0Vycm9ycygyLCBlZSlcbiAgICAgIGVlLmVtaXQoJ2VkZGllczp3YXJuJyk7XG4gICAgICBlZS5lbWl0KCdlZGRpZXM6d2FybicpO1xuICAgICAgZWUuZW1pdCgnZWRkaWVzOnN1Y2Nlc3MnKTtcbiAgICAgIGVlLmVtaXQoJ2VkZGllczp3YXJuJyk7XG4gICAgfSk7XG5cbiAgICBpdCgndGhyb3dzIGlmIG1vcmUgZXJyb3JzIHRoYW4gbnVtYmVyIGdpdmVuJywgKCkgPT4ge1xuICAgICAgdmFyIGVlID0gbmV3IEV2ZW50RW1pdHRlcigpXG4gICAgICBzdXBlcnZpc29yLl90cmFja0Vycm9ycygxLCBlZSlcbiAgICAgIGVlLmVtaXQoJ2VkZGllczp3YXJuJyk7XG4gICAgICBleHBlY3QoZWUuZW1pdC5iaW5kKGVlLCAnZWRkaWVzOndhcm4nKSkudG8udGhyb3coKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ19zdGFydEFjdG9ycycsICgpID0+IHtcbiAgICB2YXIgZXJyb3JDYiwgZW5kQ2IsIGUxLCBlcnJvckVtaXR0ZXI7XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGVycm9yQ2IgPSBzaW5vbi5zdHViKCk7XG4gICAgICBlbmRDYiA9IHNpbm9uLnN0dWIoKTtcbiAgICAgIGUxID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgZXJyb3JFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3JlY3ljbGVzLCByZXN0YXJ0cywgYW5kIHJlcG9ydHMgYW4gZXJyb3InLCBkb25lID0+IHtcbiAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignZm9vJyk7XG4gICAgICBlcnJvci5vcmlnaW5hbElucHV0ID0gJ2Jhcic7XG4gICAgICBhY3Rvck1vY2suc3RhcnQucmV0dXJucyhlMSk7XG5cbiAgICAgIHNpbm9uLnN0dWIoczMsICd3cml0ZScsICgpID0+IHRydWUpO1xuXG4gICAgICBlcnJvckVtaXR0ZXIub24oJ2VkZGllczp3YXJuJywgZXJyID0+IHtcbiAgICAgICAgZXhwZWN0KGVycikudG8uYmUuYW4oJ2Vycm9yJyk7XG5cbiAgICAgICAgLy8gZ2l2ZSBuZXh0IHRpY2sgc28gYWN0b3Iuc3RhcnQgZ2V0cyBjYWxsZWQgYWdhaW5cbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHMzLndyaXRlKS50by5oYXZlLmJlZW4uY2FsbGVkV2l0aCgnYmFyJyk7XG4gICAgICAgICAgZXhwZWN0KGFjdG9yTW9jay5zdGFydCkudG8uaGF2ZS5iZWVuLmNhbGxlZFR3aWNlO1xuICAgICAgICAgIGV4cGVjdChhY3Rvck1vY2suc3RhcnQuZmlyc3RDYWxsLmFyZ3MpXG4gICAgICAgICAgICAudG8uZGVlcC5lcXVhbChbczEsIHMyLCB0cmFuc2Zvcm1dKVxuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMoMSwgczEsIHMyLCBlcnJvckVtaXR0ZXIsIHRyYW5zZm9ybSwge3JjOiBzM30sIGVuZENiKTtcbiAgICAgIGUxLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2FzeW5jaHJvbm91c2x5IHN0YXJ0cyB0aGUgbnVtYmVyIG9mIGFjdG9ycyBpdCBpcyBhc2tlZCB0byBzdGFydCcsIGRvbmUgPT4ge1xuICAgICAgYWN0b3JNb2NrLnN0YXJ0LnJldHVybnMoZTEpO1xuICAgICAgc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMoNCwgczEsIHMyLCBlcnJvckVtaXR0ZXIsIHRyYW5zZm9ybSwgY29uZmlnLCBlbmRDYik7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgZXhwZWN0KGFjdG9yTW9jay5zdGFydC5jYWxsQ291bnQpLnRvLmVxdWFsKDQpO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9LCAyMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnaGFuZGxlcyBlcnJvcnMgZXZlbiB3aGVuIG5vIHJjIGdpdmVuJywgZG9uZSA9PiB7XG4gICAgICBhY3Rvck1vY2suc3RhcnQucmV0dXJucyhlMSk7XG4gICAgICBzdXBlcnZpc29yLl9zdGFydEFjdG9ycygxLCBzMSwgczIsIGVycm9yRW1pdHRlciwgdHJhbnNmb3JtLCBjb25maWcsIGVuZENiKTtcbiAgICAgIGVycm9yRW1pdHRlci5vbignZWRkaWVzOndhcm4nLCBlcnIgPT4ge1xuICAgICAgICBleHBlY3QoZXJyKS50by5iZS5hbi5lcnJvcjtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgICBlMS5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignZm9vJykpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnX3J1blByb3hpZXMnLCAoKSA9PiB7XG4gICAgdmFyIGVuZENiO1xuXG4gICAgYmVmb3JlKCgpID0+IHtcbiAgICAgIHZhciBzdGFydEFjdG9yTW9jayA9IGZ1bmN0aW9uIChudW0sIHNyYywgZGVzdCwgcmMsIGVlLCBjb25maWcsIF9lbmRDYil7XG4gICAgICAgIGVuZENiID0gX2VuZENiO1xuICAgICAgfVxuICAgICAgc2lub24uc3R1YihzdXBlcnZpc29yLCAnX3N0YXJ0QWN0b3JzJywgc3RhcnRBY3Rvck1vY2spO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXIoKCkgPT4gc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMucmVzdG9yZSgpKVxuXG4gICAgaXQoJ2RvZXMgbm90IHJlc29sdmUgdW50aWwgZW5kQ2IgY2FsbGVkIGVub3VnaCB0aW1lcycsIGRvbmUgPT4ge1xuICAgICAgdmFyIHJlc29sdmVkID0gZmFsc2U7XG5cbiAgICAgIHN1cGVydmlzb3IuX3J1blByb3hpZXMoczEsIHMyLCBzNCwgdHJhbnNmb3JtLCB7bnVtYmVyOiAyLCBlcnJvckNvdW50OiAxfSlcbiAgICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICByZXNvbHZlZCA9IHRydWU7XG4gICAgICAgIH0pO1xuXG4gICAgICBlbmRDYigpO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXNvbHZlZCkudG8uYmUuZmFsc2U7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Jlc29sdmVzIHdoZW4gdGhlIGVuZENiIGlzIGNhbGxlZCBhbmQgaXQgaGFzIGNhbGxlZCBzdGFydEFjdG9ycycsIGRvbmUgID0+IHtcbiAgICAgIHZhciByZXNvbHZlZCA9IGZhbHNlO1xuICAgICAgc3VwZXJ2aXNvci5fcnVuUHJveGllcyhzMSwgczIsIHM0LCB0cmFuc2Zvcm0sIHtudW1iZXI6IDMsIGVycm9yQ291bnQ6IDF9KVxuICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTtcbiAgICAgICAgICBleHBlY3Qoc3VwZXJ2aXNvci5fc3RhcnRBY3RvcnMpLnRvLmhhdmUuYmVlbi5jYWxsZWRXaXRoKDMpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSlcbiAgICAgIGVuZENiKCk7XG4gICAgICBlbmRDYigpO1xuICAgICAgZW5kQ2IoKTtcbiAgICAgIGV4cGVjdChyZXNvbHZlZCkudG8uYmUuZmFsc2U7XG4gICAgfSk7XG4gIH0pO1xuXG5cbiAgZGVzY3JpYmUoJ3N0YXJ0JywgKCkgPT4ge1xuXG4gICAgYmVmb3JlKCgpID0+IHNpbm9uLnN0dWIoc3VwZXJ2aXNvciwgJ19ydW5Qcm94aWVzJykpO1xuICAgIGJlZm9yZUVhY2goKCkgPT4gc3VwZXJ2aXNvci5fcnVuUHJveGllcy5yZXNldCgpKTtcbiAgICBhZnRlcigoKSA9PiBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJlc3RvcmUoKSk7XG5cbiAgICBpdCgncHJvcG9nYXRlcyBlcnJvcnMgdG8gcmV0dXJuZWQgc3RyZWFtJywgZG9uZSA9PiB7XG4gICAgICBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJldHVybnMoUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdmb28nKSkpO1xuICAgICAgc3VwZXJ2aXNvci5zdGFydChjb25maWcsIHRyYW5zZm9ybSwgczEsIHMyLCBzMylcbiAgICAgICAgLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICAgICAgZXhwZWN0KGVycikudG8uYmUuYW4uZXJyb3I7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIHMxLnB1c2goMSlcbiAgICB9KTtcblxuICAgIGl0KCdyZW1vdmVzIHRoZSBsaXN0ZW5lciBzbyB0aGF0IGl0IGRvZXNudCBjYWxsIHJ1blByb3hpZXMgbW9yZSB0aGFuIG9uY2UnLCBkb25lID0+IHtcbiAgICAgIHN1cGVydmlzb3IuX3J1blByb3hpZXMucmV0dXJucyhuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0cnVlKSk7XG4gICAgICBzdXBlcnZpc29yLnN0YXJ0KGNvbmZpZywgdHJhbnNmb3JtLCBzMSwgczIsIHMzKTtcbiAgICAgIHMxLnB1c2goMSk7XG4gICAgICBzMS5wdXNoKDIpO1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIHMxLnB1c2goMyk7XG4gICAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICAgIGV4cGVjdChzdXBlcnZpc29yLl9ydW5Qcm94aWVzKS50by5oYXZlLmJlZW4uY2FsbGVkT25jZTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnYWRkcyBhIGxpc3RlbmVyIHRvIHJlc3RhcnQgYWZ0ZXIgcnVuUHJveGllcyBmaW5pc2hlcycsIGRvbmUgPT4ge1xuICAgICAgdmFyIHJlc29sdmU7XG4gICAgICBzdXBlcnZpc29yLl9ydW5Qcm94aWVzLnJldHVybnMobmV3IFByb21pc2UoKF9yZXNvbHZlLCByZWplY3QpID0+IHJlc29sdmUgPSBfcmVzb2x2ZSkpO1xuICAgICAgdmFyIHN0cmVhbSA9IHN1cGVydmlzb3Iuc3RhcnQoY29uZmlnLCB0cmFuc2Zvcm0sIHMxLCBzMiwgczMpO1xuICAgICAgZXhwZWN0KHN1cGVydmlzb3IuX3J1blByb3hpZXMpLm5vdC50by5oYXZlLmJlZW4uY2FsbGVkO1xuICAgICAgczEucHVzaCgxKTtcblxuICAgICAgLy8gdGhpcyBzZXRUaW1lb3V0IHNpbXVsYXRlcyB0aGUgZmlyc3QgcmVhZGFibGUgZXZlbnRcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBleHBlY3Qoc3VwZXJ2aXNvci5fcnVuUHJveGllcykudG8uaGF2ZS5iZWVuLmNhbGxlZE9uY2U7XG5cbiAgICAgICAgLy8gQnkgcmVhZGluZyB0aGUgcXVldWUgZW1wdHksIHdlIGNyZWF0ZSB0aGUgY29uZGl0aW9ucyBmb3IgdGhlXG4gICAgICAgIC8vIHJlYWRhYmxlIGV2ZW50IHRvIGZpcmUgYWdhaW4uXG4gICAgICAgIHMxLnJlYWQoKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgICAgICAgIC8vIEFmdGVyIHdlIGhhdmUgcmVzb2x2ZWQgdGhlIHByb21pc2UsIHNpbXVsYXRpbmcgdGhlIGZpbmlzaCBvZiB0aGUgcHJveHlcbiAgICAgICAgICAvLyBhY3RvcnMsIHdlIHB1c2ggbW9yZSBkYXRhIG9udG8gdGhlIHF1ZXVlLCBzaW11bGF0aW5nIG5ldyBkYXRhLiBUaGlzXG4gICAgICAgICAgLy8gdHJpZ2dlcnMgYSBuZXcgcmVhZGFibGUgZXZldG4uXG4gICAgICAgICAgczEucHVzaCgyKTtcblxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KHN1cGVydmlzb3IuX3J1blByb3hpZXMuY2FsbENvdW50KS50by5lcXVhbCgyKTtcbiAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICB9KVxuXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgncmV0dXJucyBhIHJlYWRhYmxlIHN0cmVhbScsIGRvbmUgPT4ge1xuICAgICAgdmFyIHN0cmVhbSA9IHN1cGVydmlzb3Iuc3RhcnQoczMsIGNvbmZpZyk7XG5cbiAgICAgIHN0cmVhbS5vbigncmVhZGFibGUnLCAoKSA9PiB7XG4gICAgICAgIGV4cGVjdChzdHJlYW0ucmVhZCgpKS50by5lcXVhbCgxKTtcbiAgICAgICAgZXhwZWN0KHN0cmVhbS5yZWFkKCkpLnRvLmVxdWFsKDIpO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9KTtcblxuICAgICAgc3RyZWFtLnB1c2goMSk7XG4gICAgICBzdHJlYW0ucHVzaCgyKTtcbiAgICB9KTtcbiAgfSk7XG5cblxufSk7XG4iXX0=