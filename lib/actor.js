'use strict';

var errors = require('request-promise/errors');
var Stream = require('stream');
var EventEmitter = require('events').EventEmitter;
var _ = require('lodash');
var Promise = require('bluebird');

var actor = {};

/*
 * Helper function used to listen to backpressure.
 */
actor._write = function _write(stream, data) {
  return new Promise(function (resolve, reject) {
    if (!stream.write(data)) {
      return stream.once('drain', function () {
        stream.write(data);
        resolve();
      });
    };
    resolve();
  });
};

actor._consume = function _consume(src, dest, transform, ee, _params) {
  var input;

  input = src.read();
  if (!input) {
    return Promise.resolve('end');
  }

  return transform.apply(null, [input].concat(_params)).then(function writeToDestination(_ref) {
    var message = _ref.message;
    var params = _ref.params;

    _params = params;
    return actor._write(dest, message);
  }).then(ee.emit.bind(ee, 'success')).then(function () {
    return actor._consume(src, dest, transform, ee, _params);
  }).catch(errors.StatusCodeError, function (err) {

    // better way to tack on input!
    err.originalInput = input;
    throw err;
  });
};

actor.start = function startActor(src, dest, transform) {
  // Make sure we can read from our source
  if (!src instanceof Stream.Readable) {
    throw new TypeError('src needs to be a Readable stream with a read function');
  };

  var ee = new EventEmitter();

  try {
    actor._consume(src, dest, ee, transform).then(function (success) {
      return ee.emit('end', success);
    }).catch(function (err) {
      return _emitAndCleanup(ee, err);
    }).finally(function () {
      return ee.removeAllListeners();
    });
  } catch (e) {
    process.nextTick(function () {
      return _emitAndCleanup(ee, e);
    });
  }

  return ee;
};

/*
 * Helper function just to emit errors and cleanup listeners.
 */
function _emitAndCleanup(ee, err) {
  ee.emit('error', err);
  ee.removeAllListeners();
}

module.exports = actor;
//# sourceMappingURL=data:application/json;base64,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LENBQXBCO0tBQU4sQ0FBakIsQ0FEUTtHQUFWOztBQUlBLFNBQU8sRUFBUCxDQW5CdUQ7Q0FBM0M7Ozs7O0FBeUJkLFNBQVMsZUFBVCxDQUEwQixFQUExQixFQUE4QixHQUE5QixFQUFtQztBQUNqQyxLQUFHLElBQUgsQ0FBUSxPQUFSLEVBQWlCLEdBQWpCLEVBRGlDO0FBRWpDLEtBQUcsa0JBQUgsR0FGaUM7Q0FBbkM7O0FBS0EsT0FBTyxPQUFQLEdBQWlCLEtBQWpCIiwiZmlsZSI6ImFjdG9yLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGVycm9ycyA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZS9lcnJvcnMnKTtcbnZhciBTdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuXG52YXIgYWN0b3IgPSB7fTtcblxuLypcbiAqIEhlbHBlciBmdW5jdGlvbiB1c2VkIHRvIGxpc3RlbiB0byBiYWNrcHJlc3N1cmUuXG4gKi9cbmFjdG9yLl93cml0ZSA9IGZ1bmN0aW9uIF93cml0ZSAoc3RyZWFtLCBkYXRhKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgaWYgKCFzdHJlYW0ud3JpdGUoZGF0YSkpe1xuICAgICAgcmV0dXJuIHN0cmVhbS5vbmNlKCdkcmFpbicsICgpID0+IHtcbiAgICAgICAgc3RyZWFtLndyaXRlKGRhdGEpO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9O1xuICAgIHJlc29sdmUoKTtcbiAgfSk7XG59O1xuXG5hY3Rvci5fY29uc3VtZSA9IGZ1bmN0aW9uIF9jb25zdW1lIChzcmMsIGRlc3QsIHRyYW5zZm9ybSwgZWUsIF9wYXJhbXMpIHtcbiAgdmFyIGlucHV0O1xuXG4gIGlucHV0ID0gc3JjLnJlYWQoKTtcbiAgaWYgKCFpbnB1dCkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoJ2VuZCcpO1xuICB9XG5cbiAgcmV0dXJuIHRyYW5zZm9ybS5hcHBseShudWxsLCBbaW5wdXRdLmNvbmNhdChfcGFyYW1zKSlcbiAgICAudGhlbihmdW5jdGlvbiB3cml0ZVRvRGVzdGluYXRpb24gKHttZXNzYWdlLCBwYXJhbXN9KSB7XG4gICAgICBfcGFyYW1zID0gcGFyYW1zXG4gICAgICByZXR1cm4gYWN0b3IuX3dyaXRlKGRlc3QsIG1lc3NhZ2UpXG4gICAgfSlcbiAgICAudGhlbihlZS5lbWl0LmJpbmQoZWUsICdzdWNjZXNzJykpXG4gICAgLnRoZW4oKCkgPT4gYWN0b3IuX2NvbnN1bWUoc3JjLCBkZXN0LCB0cmFuc2Zvcm0sIGVlLCBfcGFyYW1zKSlcbiAgICAuY2F0Y2goZXJyb3JzLlN0YXR1c0NvZGVFcnJvciwgZXJyID0+IHtcblxuICAgICAgLy8gYmV0dGVyIHdheSB0byB0YWNrIG9uIGlucHV0IVxuICAgICAgZXJyLm9yaWdpbmFsSW5wdXQgPSBpbnB1dDtcbiAgICAgIHRocm93IChlcnIpO1xuICAgIH0pO1xufTtcblxuYWN0b3Iuc3RhcnQgPSBmdW5jdGlvbiBzdGFydEFjdG9yIChzcmMsIGRlc3QsIHRyYW5zZm9ybSkge1xuICAvLyBNYWtlIHN1cmUgd2UgY2FuIHJlYWQgZnJvbSBvdXIgc291cmNlXG4gIGlmICghc3JjIGluc3RhbmNlb2YgU3RyZWFtLlJlYWRhYmxlKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignc3JjIG5lZWRzIHRvIGJlIGEgUmVhZGFibGUgc3RyZWFtIHdpdGggYSByZWFkIGZ1bmN0aW9uJylcbiAgfTtcblxuICB2YXIgZWUgPSBuZXcgRXZlbnRFbWl0dGVyO1xuXG4gIHRyeSB7XG4gICAgYWN0b3JcbiAgICAgIC5fY29uc3VtZShzcmMsIGRlc3QsIGVlLCB0cmFuc2Zvcm0pXG4gICAgICAudGhlbihzdWNjZXNzID0+IGVlLmVtaXQoJ2VuZCcsIHN1Y2Nlc3MpKVxuICAgICAgLmNhdGNoKGVyciA9PiBfZW1pdEFuZENsZWFudXAoZWUsIGVycikpXG4gICAgICAuZmluYWxseSgoKSA9PiBlZS5yZW1vdmVBbGxMaXN0ZW5lcnMoKSlcbiAgfVxuICBjYXRjaCAoZSkge1xuICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4gX2VtaXRBbmRDbGVhbnVwKGVlLCBlKSk7XG4gIH1cblxuICByZXR1cm4gZWU7XG59O1xuXG4vKlxuICogSGVscGVyIGZ1bmN0aW9uIGp1c3QgdG8gZW1pdCBlcnJvcnMgYW5kIGNsZWFudXAgbGlzdGVuZXJzLlxuICovXG5mdW5jdGlvbiBfZW1pdEFuZENsZWFudXAgKGVlLCBlcnIpIHtcbiAgZWUuZW1pdCgnZXJyb3InLCBlcnIpO1xuICBlZS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBhY3RvcjtcbiJdfQ==